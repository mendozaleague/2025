<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE 2026 MENDOZA STAKES</title>
    <meta name="description" content="The 3rd Annual Running of the Bob Uecker Memorial Race to .200 - Live MLB batting average tracking">
    <meta name="author" content="Dud Lawson">
    <!-- ============================================================
         STYLES
         ============================================================ -->
    <style>
        :root {
            --blue:  #b8ddf2;
            --dark:  #2c2c2c;
            --black: #000000;
            --pink:  #cc99cc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; overflow-x: hidden; overscroll-behavior: none; }
        body { font-family: 'Arial', sans-serif; background: var(--blue); min-height: 100%; padding: 10px; padding-bottom: 30px; color: var(--dark); overflow-x: hidden; position: relative; overscroll-behavior: none; }
        @keyframes wave { 0%, 9%, 100% { transform: translateY(0); } 4.5% { transform: translateY(-10px); } }
        @keyframes wave-diamond { 0%, 9%, 100% { transform: translateY(0) rotate(45deg); } 4.5% { transform: translateY(-10px) rotate(45deg); } }
        @media (prefers-reduced-motion: no-preference) {
            /* Pre-season: continuous slow wave */
            .wave-active .wave-emoji-1 { animation: wave 11s ease-in-out 0s infinite; }
            .wave-active .wave-emoji-2 { animation: wave 11s ease-in-out 0.15s infinite; }
            .wave-active .wave-emoji-3 { animation: wave 11s ease-in-out 0.3s infinite; }
            .wave-active .wave-emoji-4 { animation: wave 11s ease-in-out 0.45s infinite; }
            .wave-active .wave-emoji-5 { animation: wave 11s ease-in-out 0.6s infinite; }
            .wave-active .wave-emoji-6 { animation: wave 11s ease-in-out 0.75s infinite; }
            .wave-active .header-diamond.wave-emoji-1 { animation: wave-diamond 11s ease-in-out 0s infinite; }
            .wave-active .header-diamond.wave-emoji-2 { animation: wave-diamond 11s ease-in-out 0.15s infinite; }
            .wave-active .header-diamond.wave-emoji-3 { animation: wave-diamond 11s ease-in-out 0.3s infinite; }
            .wave-active .header-diamond.wave-emoji-4 { animation: wave-diamond 11s ease-in-out 0.45s infinite; }
            .wave-active .header-diamond.wave-emoji-5 { animation: wave-diamond 11s ease-in-out 0.6s infinite; }
            .wave-active .header-diamond.wave-emoji-6 { animation: wave-diamond 11s ease-in-out 0.75s infinite; }
            /* Season: one-shot bounce on fetch */
            .wave-bounce .wave-emoji-1 { animation: wave 11s ease-in-out 0s 1; }
            .wave-bounce .wave-emoji-2 { animation: wave 11s ease-in-out 0.15s 1; }
            .wave-bounce .wave-emoji-3 { animation: wave 11s ease-in-out 0.3s 1; }
            .wave-bounce .wave-emoji-4 { animation: wave 11s ease-in-out 0.45s 1; }
            .wave-bounce .wave-emoji-5 { animation: wave 11s ease-in-out 0.6s 1; }
            .wave-bounce .wave-emoji-6 { animation: wave 11s ease-in-out 0.75s 1; }
            .wave-bounce .header-diamond.wave-emoji-1 { animation: wave-diamond 11s ease-in-out 0s 1; }
            .wave-bounce .header-diamond.wave-emoji-2 { animation: wave-diamond 11s ease-in-out 0.15s 1; }
            .wave-bounce .header-diamond.wave-emoji-3 { animation: wave-diamond 11s ease-in-out 0.3s 1; }
            .wave-bounce .header-diamond.wave-emoji-4 { animation: wave-diamond 11s ease-in-out 0.45s 1; }
            .wave-bounce .header-diamond.wave-emoji-5 { animation: wave-diamond 11s ease-in-out 0.6s 1; }
            .wave-bounce .header-diamond.wave-emoji-6 { animation: wave-diamond 11s ease-in-out 0.75s 1; }
            .batting-display.is-loading .batting-average { animation: pulse 1.2s ease-in-out infinite; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.35; }
            50% { opacity: 0.7; }
        }
        /* display:inline-block is layout, not animation ‚Äî always applied */
        .wave-emoji-1, .wave-emoji-2, .wave-emoji-3,
        .wave-emoji-4, .wave-emoji-5, .wave-emoji-6 { display: inline-block; }
        .container { max-width: 100%; margin: 0 auto; padding-bottom: 20px; }
        .header { text-align: center; margin-bottom: 0; padding: 15px; background: var(--blue); border: 2px solid var(--blue); }
        .header h1 { font-size: 2.0rem; margin-bottom: 0; color: black; line-height: 1.2; }
        .header-diamond { display: inline-block; width: 1.2rem; height: 1.2rem; background-color: black; transform: rotate(45deg); margin: 0 0.15rem; vertical-align: middle; }
        .header .race-title { font-size: 0.95rem; color: var(--blue); line-height: 1; font-weight: normal; font-style: normal; margin: 0; padding: 0; white-space: nowrap; display: flex; align-items: center; }
        .hexagon-bar  {
            position: relative;
            background: black;
            padding: 0 12px;
            margin: 8px auto 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
            width: auto;
            box-sizing: border-box;
            max-width: fit-content;
            min-width: 257px;
        }
        .live-standings { text-align: center; margin-bottom: 20px; font-size: 0.9rem; color: var(--dark); }
        .live-standings a { color: var(--dark); text-decoration: underline; cursor: pointer; }
        .mendoza-line-divider { text-align: center; margin: -15px 0 0 0; padding: 15px 12px; position: relative; color: var(--dark); font-weight: bold; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; }
        .mendoza-line-divider::before, .mendoza-line-divider::after { content: ''; position: absolute; top: 50%; width: calc(50% - 140px); height: 2px; background-color: var(--dark); pointer-events: none; }
        .mendoza-line-divider::before { left: 0; }
        .mendoza-line-divider::after { right: 0; }
        @media (hover: hover) {
            #mendoza-line-trigger:hover .mendoza-line-text { text-decoration: underline; }
        }
        .copyright { text-align: center; margin-top: 15px; font-size: 0.8rem; opacity: 0.8; color: var(--pink); }
        .copyright a { color: var(--pink); text-decoration: underline; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; overscroll-behavior: contain; }
        .modal.open { display: block; }
        .modal-content { background-color: var(--blue); margin: 20px auto; padding: 20px; width: 80%; max-width: 500px; position: relative; max-height: calc(100vh - 40px); overflow-y: auto; }
        .close { color: var(--dark); position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; line-height: 20px; cursor: pointer; z-index: 10; }
        .close:hover, .close:focus { color: black; }
        .rules-symbol-bottom { text-align: center; color: var(--dark); margin-top: 15px; font-size: 1rem; letter-spacing: -0.25rem; }
        .rules-divider { text-align: center; margin: 20px 0; color: var(--blue); background: black; font-weight: bold; font-size: 1rem; padding: 10px; }
        .modal-content p { color: var(--dark); line-height: 1.5; margin-bottom: 12px; text-align: center; font-size: 0.95rem; }
        .player-row { display: flex; align-items: center; padding: 15px 12px; position: relative; }
        .player-row.first-place { background: black; color: var(--blue); }
        .player-row.second-place { background: var(--blue); color: black; }
        .player-row:last-child { border-bottom: none; }
        .player-info { flex: 1; display: flex; justify-content: space-between; align-items: center; min-width: 0; width: 100%; }
        .player-name { font-size: 1.5rem; font-weight: bold; line-height: 1.2; position: relative; padding-left: 0; cursor: pointer; display: flex; align-items: center; outline: none; -webkit-tap-highlight-color: transparent; }
        .player-name:focus, .player-name:focus-visible { outline: none; }
        .player-name.tbd-line .tbd-text { display: none; }
        .player-name.tbd-line::after { content: ''; display: inline-block; width: 11ch; height: 2px; background-color: currentColor; vertical-align: middle; }
        .batting-stats { text-align: right; flex-shrink: 0; position: relative; min-width: 0; }
        .batting-display.is-loading .batting-average {
            opacity: 0.35;
            animation: pulse 1.2s ease-in-out infinite;
        }
        #loading-banner {
            text-align: center;
            padding: 12px;
            background: black;
            color: var(--blue);
            font-family: 'Brush Script MT', cursive, 'Arial', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.03em;
            display: none;
        }
        #loading-banner.visible { display: block; }
        .batting-display  {
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1.2;
            cursor: pointer;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            text-align: right;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .batting-display:focus, .batting-display:focus-visible { outline: none; }
        .batting-average { position: relative; z-index: 1; text-align: right; }
        .tap-tooltip  {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 2;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
            text-align: right;
            white-space: nowrap;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            border-radius: 4px;
            width: 100%;
        }
        .player-row.first-place .tap-tooltip { color: var(--blue); background-color: black; }
        .player-row.second-place .tap-tooltip { color: black; background-color: var(--blue); }
        .batting-display:hover .tap-tooltip, .batting-display.active .tap-tooltip { opacity: 1; visibility: visible; }
        .player-modal-content { background-color: var(--blue); margin: 20px auto; padding: 30px 20px; width: 80%; max-width: 500px; position: relative; max-height: calc(100vh - 40px); overflow-y: auto; }
        .player-modal-header { text-align: center; margin-bottom: 20px; margin-top: 20px; position: relative; }
        .player-modal-header h2  {
            font-size: 2rem;
            color: var(--blue);
            background: black;
            margin-bottom: 10px;
            padding: 10px 48px 10px 48px;
            font-weight: bold;
            transition: opacity 0.2s;
            display: block;
            text-align: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .player-modal-header .player-number  {
            background-color: var(--blue);
            color: black;
            font-size: 1rem;
            width: 1.5rem;
            height: 1.5rem;
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg);
            margin-right: 0;
            z-index: 10;
        }
        .player-modal-header .player-position  {
            background-color: var(--blue);
            color: black;
            font-size: 0.8rem;
            font-weight: bold;
            width: 1.5rem;
            height: 1.5rem;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%) rotate(45deg);
            margin-right: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .player-modal-header .player-position span { transform: rotate(-45deg); }
        .player-modal-header h2:hover { opacity: 0.8; }
        .player-modal-stats-container { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; position: relative; }
        .player-status-indicator { text-align: center; font-size: 0.75rem; color: var(--dark); font-weight: bold; line-height: 1.3; }
        .player-trend-indicator { text-align: center; font-size: 0.75rem; color: var(--dark); font-weight: bold; line-height: 1.3; }
        .player-modal-stats { flex: 1; text-align: center; color: var(--dark); padding: 0 20px; }
        .player-modal-stats p { font-size: 1rem; margin-bottom: 6px; line-height: 1.4; }
        .player-modal-stats strong { font-weight: bold; }
        .screw-flanders { text-align: center; font-size: 1rem; line-height: 1.6; color: var(--dark); word-wrap: break-word; margin-top: 20px; margin-bottom: 15px; }
        .bio-symbol  {
            color: var(--blue);
            margin-top: 15px;
            font-size: 0.75rem;
            font-weight: bold;
            background-color: black;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .bio-close-btn { text-align: center; margin-top: 20px; font-size: 0.75rem; font-weight: bold; cursor: pointer; color: var(--blue); background-color: black; padding: 8px 16px; display: inline-block; }
        .bio-close-btn:hover { opacity: 0.7; }
        .run-simulation-btn  {
            background: black;
            padding: 0 12px;
            margin: 0 auto;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
            width: auto;
            box-sizing: border-box;
            max-width: fit-content;
            position: relative;
        }
        .run-simulation-btn::before,
        .run-simulation-btn::after {
            content: '';
            position: absolute;
            top: 0;
            width: 0;
            height: 0;
            border-style: solid;
        }
        .run-simulation-btn::before {
            left: -0.75rem;
            border-width: 0.75rem 0.75rem 0.75rem 0;
            border-color: transparent black transparent transparent;
        }
        .run-simulation-btn::after {
            right: -0.75rem;
            border-width: 0.75rem 0 0.75rem 0.75rem;
            border-color: transparent transparent transparent black;
        }
        .run-simulation-btn:hover { opacity: 0.7; }
        #horse-animation { 
            font-size: 0.7rem; 
            line-height: 1.1; 
            white-space: pre; 
            overflow-x: auto; 
            max-width: 100%; 
            color: var(--dark);
        }
        .player-number  {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.2rem;
            height: 1.2rem;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
            transform: rotate(45deg);
        }
        .player-number span { display: block; transform: rotate(-45deg); }
        .player-row.first-place .player-number { background-color: var(--blue); color: black; }
        .player-row.second-place .player-number { background-color: black; color: var(--blue); }
        .contact-modal-content { background-color: var(--blue); margin: 20px auto; padding: 30px 20px; width: 80%; max-width: 500px; position: relative; max-height: calc(100vh - 40px); overflow-y: auto; }
        .contact-modal-header { text-align: center; margin-bottom: 20px; }
        .contact-modal-header h2 { font-size: 1.5rem; color: var(--dark); margin-bottom: 20px; font-weight: bold; }
        .contact-form-group { margin-bottom: 20px; }
        .contact-form-group label { display: block; color: var(--dark); font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; }
        .contact-form-group input, .contact-form-group textarea { width: 100%; padding: 10px; border: none; background: white; color: var(--dark); font-family: 'Arial', sans-serif; font-size: 0.95rem; border-radius: 0; outline: none; }
        .contact-form-group input:focus, .contact-form-group textarea:focus { border: 2px solid black; padding: 8px; }
        .contact-form-group textarea { min-height: 150px; resize: vertical; }
        .contact-form-group input::placeholder, .contact-form-group textarea::placeholder { color: #555; opacity: 0.7; }
        .contact-submit-btn { background: black; color: var(--blue); border: none; padding: 12px 30px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; transition: opacity 0.2s; }
        .contact-submit-btn:hover { opacity: 0.8; }
        @media (max-width: 768px) {
            body { padding: 8px; padding-bottom: 30px; }
            .modal-content { width: 90%; margin: 10px auto; padding: 20px; max-height: calc(100vh - 20px); }
            .player-modal-content { width: 90%; padding: 25px 15px; }
            .player-modal-header h2 { font-size: 1.5rem; }
            .player-modal-stats p { font-size: 0.9rem; }
            .screw-flanders { font-size: 0.9rem; }
            .rules-divider { font-size: 1rem; }
            .header h1 { font-size: 1.75rem; }
            .header-diamond { width: 1.05rem; height: 1.05rem; margin: 0 0.12rem; }
            .header p { font-size: 0.85rem; }
            .mendoza-line-divider { font-size: 1.2rem; }
            .mendoza-line-divider::before, .mendoza-line-divider::after { width: calc(50% - 110px); }
            .player-row { padding: 12px 10px; }
            .player-name { font-size: 1.25rem; }
            .batting-display { font-size: 1.25rem; }
            .tap-tooltip { font-size: 1.25rem; padding: 0; }
            #horse-animation { 
                font-size: 0.5rem; 
                line-height: 1.0;
            }
            #race-title {
                font-size: 0.7rem !important;
                line-height: 1.2 !important;
            }
        }
    </style>
</head>
<body>

    <!-- ============================================================
         MAIN CONTENT
         ============================================================ -->
    <div class="container">
        <div class="header">
            <h1><strong>
                <button id="diamond-trigger" aria-label="Live update info" style="background:none;border:none;padding:0;cursor:pointer;font:inherit;color:inherit;line-height:inherit;">
                <span class="header-diamond wave-emoji-1"></span>
                <span class="header-diamond wave-emoji-2"></span>
                <span class="header-diamond wave-emoji-3"></span></button>
                2026
                <button id="diamond-trigger-2" aria-label="Live update info" style="background:none;border:none;padding:0;cursor:pointer;font:inherit;color:inherit;line-height:inherit;">
                <span class="header-diamond wave-emoji-4"></span>
                <span class="header-diamond wave-emoji-5"></span>
                <span class="header-diamond wave-emoji-6"></span></button>
                <br>MENDOZA STAKES
            </strong></h1>
            <div class="hexagon-bar">
                <p class="race-title" id="season-subtitle"><i>Season Eleven</i>‚¨©<i id="week-label">Week One</i></p>
            </div>
        </div>
        <div class="mendoza-line-divider" id="mendoza-line-trigger" style="cursor: pointer;">"<span class="mendoza-line-text">THE MENDOZA LINE</span>"</div>
        <div id="loading-banner">Hold Yer Horses...</div>
        <div id="standings-container">
        </div>
        <div style="text-align: center; margin: 15px 0;">
            <button id="bugle-trigger" style="cursor: pointer; text-decoration: none; background: none; border: none; padding: 0;" aria-label="Run race simulation">
                <div class="run-simulation-btn">
                    <p style="font-size: 1.1rem; color: #b8ddf2; line-height: 1; font-weight: normal; font-style: italic; margin: 0; padding: 0; white-space: nowrap; font-family: 'Arial', sans-serif;">Look at 'em Go!!</p>
                </div>
            </button>
        </div>
        <div class="live-standings">
            <p>2026 Race for 200 <a id="rules-trigger"><strong><u>PARAMETERS</u></strong></a><br><a id="contact-trigger"><strong><u>CONTACT</u></strong></a> your loyal Commissioner<br><strong id="live-indicator"><span id="countdown-timer">00:00:00:00</span> 'TIL POST TIME</strong></p>
        </div>
        <div class="copyright"><i>Hits are for Squares</i> ¬©MMXXVI</div>
    </div>

    <!-- ============================================================
         MODALS
         ============================================================ -->
    <div id="rules-modal" class="modal" role="dialog" aria-modal="true" aria-label="Race Parameters">
        <div class="modal-content">
            <span class="close" data-modal="rules">&times;</span>
            <h1 style="font-size: 2.0rem; margin: 15px 0 20px 0; color: black; font-weight: bold; text-align: center;"><strong>PARAMETERS</strong></h1>
            <div class="rules-divider">WAGERING</div>
            <p><strong>Pre-Race Tickets: $25</strong><br><span style="font-size: 0.85rem;">Available during Spring Training</span></p>
            <p><strong>Mid-Race Tickets: $45</strong><br><span style="font-size: 0.85rem;">Available during All-Star Break</span></p>
            <div class="rules-divider">ENTRY/FEES</div>
            <p>Please send picks & payments to<br>your loyal <a href="/cdn-cgi/l/email-protection#e2818d8f8f8b918aa28f878c868d98838e8783859787cc818d8fdd91978088878196dfa58b9487c7d0d28f87c7d0d2bdbdc7d0d2968b8189879691c7d0d2848d90c7d0d2bdbdbdbdbdbdbdbdbdbdbdcec7d0d2a18d8f8f8b918ac3" style="color: #2c2c2c; text-decoration: underline; font-weight: bold;">Commissioner</a> via <strong>VENMO</strong><br>before Monday, May 25, 2026</p>
            <div class="rules-divider">PAYOUTS</div>
            <p><strong>ALL-STAR BREAK: July 10, 2026</strong></p>
            <p style="font-size: 0.8rem;">20% of purse split between ticket holders<br>of FIRST batter to reach 200 At Bats</p>
            <p><strong>FINISH LINE: September 27, 2026</strong></p>
            <p style="font-size: 0.8rem;">Remaining purse + all Mid-Race ticket funds<br>split between ticket holders of eligible batter<br>(MIN 200 AB) closest* to The Mendoza Line</p>
            <p style="font-size: 0.8rem; font-style: italic; margin-top: 20px;">*Above or below a .200 Batting Average</p>
        </div>
    </div>
    <div id="player-modal" class="modal" role="dialog" aria-modal="true" aria-label="Player Details">
        <div class="player-modal-content">
            <span class="close" data-modal="player">&times;</span>
            <div class="player-modal-header">
                <span id="player-modal-number"></span>
                <span id="player-modal-position"></span>
                <h2 id="player-modal-name"></h2>
            </div>
            <div class="player-modal-stats-container">
                <div class="player-modal-stats">
                    <p id="player-modal-details"></p>
                    <p id="player-modal-2025-stats"></p>
                    <p id="player-modal-2026-stats"></p>
                    <p id="player-modal-current-stats"></p>
                    <p id="player-modal-games" style="font-size: 0.9rem; margin-top: 5px; margin-bottom: 8px;"></p>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding: 0 20px;">
                <div class="player-status-indicator" style="position: static; transform: none;">
                    <div style="font-size: 0.65rem;">STATUS:</div>
                    <div id="player-status" style="font-size: 0.65rem;">WINTER</div>
                </div>
                <div id="player-team-designation" style="font-family: 'Brush Script MT', cursive, 'Arial', sans-serif; font-size: 1.25rem; text-align: center; color: #2c2c2c; font-style: italic; padding: 0 10px; flex: 1; line-height: 1.4; white-space: nowrap;"></div>
                <div class="player-trend-indicator" style="position: static; transform: none;">
                    <div style="font-size: 0.65rem;">TREND:</div>
                    <div id="player-trend" style="font-size: 0.65rem;">---</div>
                </div>
            </div>
            <div style="width: 100%; height: 6px; background-color: #2c2c2c; margin-bottom: 15px;"></div>
            <div class="screw-flanders" id="player-modal-screw"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 4px;">
                <div id="select-batter-btn" style="cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.75rem; font-weight: bold; letter-spacing: 0.05em; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; padding: 8px 0;">
                    <span id="select-batter-diamond" style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; transform: rotate(45deg); flex-shrink: 0;"></span>
                    <span id="select-batter-label">SELECT BATTER</span>
                </div>
            </div>
        </div>
    </div>
    <div id="contact-modal" class="modal" role="dialog" aria-modal="true" aria-label="Contact the Commissioner">
        <div class="contact-modal-content">
            <span class="close" data-modal="contact">&times;</span>
            <div class="contact-modal-header">
                <h2>CONTACT YOUR LOYAL COMMISSIONER</h2>
            </div>
            <form id="contact-form" action="https://formspree.io/f/xnjpgbpj" method="POST">
                <div class="contact-form-group">
                    <label for="contact-email">YOUR EMAIL:</label>
                    <input type="email" id="contact-email" name="email" required>
                </div>
                <div class="contact-form-group">
                    <label for="contact-message">YOUR MESSAGE:</label>
                    <textarea id="contact-message" name="message" placeholder="Sign me up, Commish!!" required></textarea>
                </div>
                <button type="submit" class="contact-submit-btn">SEND MESSAGE</button>
            </form>
        </div>
    </div>
    <div id="horse-modal" class="modal" role="dialog" aria-modal="true" aria-label="Race Animation">
        <div class="modal-content" style="background-color: black; max-width: 90%; width: 1200px; height: 550px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
            <div id="race-title" style="font-family: monospace; font-size: 0.85rem; line-height: 1.3; color: #b8ddf2; text-align: center; margin-bottom: 10px; white-space: pre-line; visibility: hidden;">MendozaLeague.com Presents the 3rd Annual
Bob Uecker Memorial Race for Two Hundred</div>
            <div style="position: relative; flex: 1; width: 100%;">
                <div id="horse-animation" style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; font-family: monospace; font-size: 1.5rem; line-height: 2.5; color: #b8ddf2; overflow: hidden;"></div>
                <div id="finish-line" style="position: absolute; right: 0; display: none; flex-direction: column; justify-content: space-between; font-family: monospace; font-size: 0.7rem; line-height: 1.2; color: #b8ddf2; white-space: pre; padding: 0;"></div>
            </div>
            <div id="horse-text" style="font-family: monospace; font-size: 0.85rem; line-height: 1.3; color: #b8ddf2; text-align: center; margin-top: 0px; white-space: normal; visibility: hidden; min-height: 5.5rem; display: flex; flex-direction: column; justify-content: flex-start;"></div>
        </div>
    </div>

    <!-- Diamond info modal -->
    <div id="diamond-modal" class="modal" role="dialog" aria-modal="true" aria-label="Live Update Info">
        <div class="modal-content" style="text-align: center; max-width: 340px; background-color: black; color: var(--blue);">
            <p style="margin-bottom: 0; font-family: monospace; letter-spacing: 0.05em; color: var(--blue);">UPDATES ON THE ELEVENS</p>
            <p style="font-weight: bold; margin-bottom: 0; font-family: monospace; letter-spacing: 0.05em; color: var(--blue);">1<sup>st</sup> PITCH TO FINAL OUT DAILY</p>
            <p id="diamond-modal-last-update" style="margin-bottom: 0; font-family: monospace; letter-spacing: 0.05em; color: var(--blue);"></p>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const OPENING_DAY_FIRST_PITCH = new Date('2026-03-26T01:05:11Z'); // 5:05:11PM PT / 7:05:11PM CT / 8:05:11PM ET

// ============================================================
// SEASON CONFIGURATION ‚Äî update these each year, nothing else
// ============================================================
const SEASON = {
    year:              2026,
    springTraining:    new Date('2026-02-12T00:00:00'),
    openingDay:        new Date('2026-03-25T00:00:00'),
    allStarBreakStart: new Date('2026-07-11T00:00:00'),
    allStarBreakEnd:   new Date('2026-07-15T00:00:00'),
    finishLine:        new Date('2026-09-27T23:59:59'),
    wbcStart:          new Date('2026-03-05T00:00:00'),
    wbcEnd:            new Date('2026-03-17T23:59:59'),
};

// ============================================================
// DYNAMIC WEEK LABEL
// ============================================================
(function() {
    const now = new Date();
    const weekLabelEl = document.getElementById('week-label');
    if (!weekLabelEl) return;

    const weekNames = [
        'Week One', 'Week Two', 'Week Three', 'Week Four', 'Week Five',
        'Week Six', 'Week Seven', 'Week Eight', 'Week Nine', 'Week Ten',
        'Week Eleven', 'Week Twelve', 'Week Thirteen', 'Week Fourteen',
        'Week Fifteen', 'Week Sixteen', 'Week Seventeen', 'Week Eighteen',
        'Week Nineteen', 'Week Twenty', 'Week Twenty-One', 'Week Twenty-Two',
        'Week Twenty-Three', 'Week Twenty-Four', 'Week Twenty-Five', 'Week Twenty-Six'
    ];

    if (now < SEASON.openingDay) {
        // Before season: show Spring Training or Pre-Season
        if (now >= SEASON.springTraining) {
            weekLabelEl.textContent = 'Spring Training';
        } else {
            weekLabelEl.textContent = 'Pre-Season';
        }
    } else if (now >= SEASON.allStarBreakStart && now < SEASON.allStarBreakEnd) {
        weekLabelEl.textContent = 'All-Star Break';
    } else if (now > SEASON.finishLine) {
        weekLabelEl.textContent = 'Final Standings';
    } else {
        // Calculate week number from opening day
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weekNum = Math.floor((now - SEASON.openingDay) / msPerWeek);
        weekLabelEl.textContent = weekNames[weekNum] || ('Week ' + (weekNum + 1));
    }
})();

// ============================================================
// PLAYER DATA
// NOTE: Each player entry should include a birthday field:
//   birthday: { month: M, day: D }  ‚Üê required for üéÇ on leaderboard
// ============================================================
const playerData = {
    1: {
        name: "P.C.A.",
        number: "4",
        position: "OF",
        fullName: "Pete Crow-Armstrong",
        wbcFlag: "üá∫üá∏",
        birthday: { month: 3, day: 25 },
        mlbId: 691718,
        league: 'Senior Circuit',
        bio: "<i>Technically</i> the Cubs mascot is a pantsless bear named Clark, but the <i>real</i> face of the franchise is Pete Crow-Armstrong. & boy has Chicago's National League ballclub been trotting him around town! On the sideline with the Bears‚Ä¶ behind the glass at Blackhawks games with the Bears quarterback‚Ä¶ even working out in purple with Chicago's Big Ten Team. It makes sense that Pete's become THE North Side fan favorite after his All Star season in 2025. He absolutely racked up At Bats with only 29 walks all year, & hit a Khris Davis-approved .247 with 31 home runs‚Ä¶ but only 7 of those dingers came in the second half. Yikes! Will P.C.A. be refreshed for 2026 or was the end of last season the beginning of a disappointing denouement?"
    },

    2: {
        name: "M. MURAKAMI",
        number: "5",
        position: "DH",
        fullName: "Munetaka Murakami",
        wbcFlag: "üáØüáµ",
        birthday: { month: 2, day: 2 },
        mlbId: 808959,
        league: 'Junior Circuit',
        age: 25,
        height: "6'2\"",
        weight: "213lbs",
        battingAvg2025: "*",
        battingAvgValue: ".273/187AB",
        games: "",
        pecota2026: ".230",
        url: "https://www.baseball-reference.com/register/player.fcgi?id=muraka000mun",
        bio: "One of the biggest bats in Japanese baseball history is bringing his talent (& 30% strikeout rate) to the south side of Chicago! Murakami hit a Nippon Professional Baseball record 56 h≈çmurans in 2022. He most recently missed about half of last season with an oblique injury, but still hit .273 with 187 At Bats *in 56 games. That was against Japanese pitching, though‚Ä¶ & the only MLB front office willing to take the risk was none other than Chicago's American League ballclub. Never change, Jerry!!"
    },

    3: {
        name: "M. MUNCY",
        number: "10",
        position: "IF",
        fullName: "MAX P. MUNCY",
        wbcFlag: null,
        birthday: { month: 8, day: 25 },
        mlbId: 691777,
        league: 'Junior Circuit',
        age: 23,
        height: "6'1\"",
        weight: "180lbs",
        battingAvg2025: ".214/206AB",
        pecota2026: ".221",
        url: "https://www.baseball-reference.com/register/player.fcgi?id=muncy-002max",
        bio: "In 2025, Max Muncy finished his rookie season 14 points above The Mendoza Line in 206 At Bats. Let's be clear THIS Max Muncy is NOT the Max Muncy who competed in last year's Mendoza Stakes. THAT Max Muncy is a 10-year veteran infielder for the Los Angeles National League ballclub. THIS Max Muncy is a SOPHOMORE infielder for what is currently the SACRAMENTO American League ballclub. The wildest part is you can't even say THIS Max Muncy is \"the one born on August 25\" because BOTH Maxes Muncy were born on August 25th. How about that!"
    },

    4: {
        name: "B. NAYLOR",
        number: "14",
        position: "C",
        fullName: "Noah-Gibson \"Bo\" Naylor",
        wbcFlag: null,
        birthday: { month: 2, day: 21 },
        mlbId: 647304,
        league: 'Junior Circuit',
        age: 25,
        height: "6'0\"",
        weight: "205lbs",
        battingAvg2025: ".195/359AB",
        pecota2026: ".224",
        url: "https://www.baseball-reference.com/players/n/naylobo01.shtml",
        bio: "If Noah-Gibson Naylor, better known as Bo, sounds vaguely familiar it's probably because his older brother Josh plays for the Mariners. Bo only hit .195 last season, yet still seems to be Cleveland's guy behind the plate in the foreseeable future. At the time of this writing, the other two catchers on their roster are David Fry (.171/146AB) & journeyman Austin Hedges (.161/155) so it seems like his job is safe? You can only go up from here, Bo! Unless you go down, of course. That's still a very real possibility."
    },

    5: {
        name: "O. CRUZ",
        number: "15",
        position: "IF",
        fullName: "Oneil Cruz",
        wbcFlag: "üá©üá¥",
        birthday: { month: 10, day: 4 },
        mlbId: 665833,
        league: 'Senior Circuit',
        age: 25,
        height: "6'7\"",
        weight: "240lbs",
        battingAvg2025: ".200/514AB",
        pecota2026: ".223",
        url: "https://www.baseball-reference.com/players/c/cruzon01.shtml",
        bio: "Holy cow, could Oneil Cruz be the true heir to the Mendoza Crown? Not only does he play Mario Mendoza's position on the team Mario Mendoza spent most of his career playing for ‚Äî he also hit EXACTLY .200 last year. Not even Mario Mendoza himself ever did that!!"
    },

    6: {
        name: "C. MOREL",
        number: "24",
        position: "IF",
        fullName: "Christopher Morel",
        wbcFlag: null,
        birthday: { month: 6, day: 24 },
        mlbId: 666624,
        league: 'Senior Circuit',
        age: 26,
        height: "6'0\"",
        weight: "200lbs",
        battingAvg2025: ".219/278AB",
        pecota2026: ".223",
        url: "https://www.baseball-reference.com/players/m/morelch01.shtml",
        bio: "Christopher Morel paints two lines of eye black on his cheeks like Peter Criss from Kiss. Maybe it's more Hello Kitty? Either way, it's pretty goofy. Morel dipped below The Mendoza Line in 2024, & getting back on top last season wasn't enough to keep him from getting DFAd by Tampa Bay last December. He signed a one-year deal to play first base for Miami ‚Äî a position he has never played before in his life. It's <i>Moneyball</i>, y'all! Chris Morel is Chris Pratt!!"
    },

    7: {
        name: "D. MOORE",
        number: "25",
        position: "UT",
        fullName: "Dylan Moore",
        wbcFlag: null,
        birthday: { month: 8, day: 2 },
        mlbId: 664238,
        league: 'Junior Circuit',
        age: 32,
        height: "6'0\"",
        weight: "205lbs",
        battingAvg2025: ".201/219AB",
        pecota2026: "N/A",
        url: "https://www.baseball-reference.com/players/m/mooredy01.shtml",
        bio: "<strong>UPDATE: Feb 16, 2026</strong><br><br>Well, well, well! Look look who Philadelphia invited to Spring Training to potentially take the place of ousted outfielder (and 2026 Mendoza Stakes competitor) Nick Castellanos. Mr. Moore is out of options, so he either starts on the Phillies or not at all. Godspeed, \"Champ!\"<br><br>‚¨©‚¨©‚¨©‚¨©‚¨©‚¨©‚¨©‚¨©‚¨©‚¨©‚¨©<br><br>Whether or not \"D-Mo\" even makes a 2026 Major League roster remains to be seen, but his \"stellar\" performance last year was enough to secure the first spot in the 3rd annual Bob Uecker Memorial Race to Two Hundred. Our 2025 \"Champion\" finished one single point above the Mendoza Line, which is pretty dang \"impressive.\" The 2024 Gold Glove-winning Utility Man spent the entirety of his seven-year pro career with Seattle until being released on August 23. Three days later, he was picked up by the same team that drafted him: the Texas Rangers. What a coincidence, a Mendoza Stakes winner playing for 2/3 of Mario Mendoza's teams in one season!"
    },

    8: {
        name: "L. ROBERT Jr.",
        number: "88",
        position: "OF",
        fullName: "Luis Robert, Junior",
        wbcFlag: null,
        birthday: { month: 8, day: 3 },
        mlbId: 673357,
        league: 'Senior Circuit',
        age: 28,
        height: "6'3\"",
        weight: "225lbs",
        battingAvg2025: ".224/395AB",
        pecota2026: ".233",
        url: "https://www.baseball-reference.com/players/r/roberlu01.shtml",
        bio: "The 2021 Chicago White Sox were supposed to be The Future. Now five years removed from seemingly limitless potential & two seasons after claiming the title of \"worst team in history,\" nearly every player from the core built to bring the South Side \"multiple parades\" is gone. Luis Robert, Jr. will spend this summer in Queens, coincidentally replacing last season's Metropolitan Center Fielder, Jose Siri (who may I remind you, broke his dang leg like an actual horse). Junior hit .233 last year & maybe a change of scenery will help ‚Äî even if it's mainly just an airport & scrapyards."
    },

    9: {
        name: "N. CASTELLANOS",
        number: "21",
        position: "OF",
        fullName: "Nicholas Castellanos",
        wbcFlag: null,
        birthday: { month: 3, day: 4 },
        mlbId: 592206,
        league: 'Senior Circuit',
        age: 34,
        height: "6'5\"",
        weight: "218lbs",
        battingAvg2025: ".250/547AB",
        pecota2026: ".246",
        url: "https://www.baseball-reference.com/players/c/casteni01.shtml",
        bio: "Man, everybody <i>hates</i> Nick Castellanos. Your loyal Commissioner has remained willfully ignorant about what went down to totally fracture the relationship with his former team, but it involved him cracking open a Dominican beer in the dugout after being pulled for a defensive replacement. He's now officially on the Padres roster making the league minimum, which makes one consider if San Diego's National League Ball Club has a minimum Bad Vibes quota every season. So what's 2026 have in store for the home run-hitting harbinger of bad news? Worst case scenario is a Ritchie Tenenbaum-esque \"He's taken off his shoes & one of his socks ‚Äî actually I think he's crying\" situation that sucks him toward The Mendoza Line. Best case is he continues to absolutely never, <i>ever</i> walk & runs off with the Race to 200AB in the first half."
    },

    10: {
        name: "SOON COME (AL)",
        number: "?",
        position: "",
        fullName: "SOON COME (AL)",
        wbcFlag: null,
        // ‚ö†Ô∏è ADD birthday: { month: M, day: D } when this player is filled in
        mlbId: null,
        age: "TBD",
        height: "TBD",
        weight: "TBD",
        battingAvg2025: ".---/---AB",
        pecota2026: ".---/---AB",
        url: "",
        bio: ""
    },

    11: {
        name: "SOON COME (AL)",
        number: "?",
        position: "",
        fullName: "SOON COME (AL)",
        wbcFlag: null,
        // ‚ö†Ô∏è ADD birthday: { month: M, day: D } when this player is filled in
        mlbId: null,
        age: "TBD",
        height: "TBD",
        weight: "TBD",
        battingAvg2025: ".---/---AB",
        pecota2026: ".---/---AB",
        url: "",
        bio: ""
    }
};

let playersArray = [];

function initializePlayers() {
    const now = new Date();
    playersArray = Object.keys(playerData).map((id, index) => ({
        id: parseInt(id),
        originalOrder: index,
        ...playerData[id],
        currentAvg: null,
        liveAtBats: null,
        liveHits: null,
        distanceFrom200: 1000
    }));

    rankPlayers(now);
    renderPlayers(now);
    applySelectedBatterStyles();
}

function calculateDistanceFrom200(avg) {
    if (avg === null || avg === undefined || isNaN(avg)) return 1000;
    return Math.abs(avg - 0.200);
}

function rankPlayers(now) {
    now = now || new Date();
    const openingDay = SEASON.openingDay;
    
    if (now < openingDay) {
        // Before opening day: sort by jersey number
        playersArray.sort((a, b) => {
            const numA = playerData[a.id]?.number;
            const numB = playerData[b.id]?.number;
            
            // Handle '?' as highest value
            if (numA === '?' && numB === '?') return a.originalOrder - b.originalOrder;
            if (numA === '?') return 1;
            if (numB === '?') return -1;
            
            // Sort numerically
            return parseInt(numA) - parseInt(numB);
        });
    } else {
        // After opening day: sort by distance from .200
        playersArray.sort((a, b) => {
            const distA = a.distanceFrom200;
            const distB = b.distanceFrom200;
            if (distA !== distB) return distA - distB;
            return a.originalOrder - b.originalOrder;
        });
    }
}

// Returns true if today is the player's birthday
function isBirthday(player, now) {
    if (!player.birthday) return false;
    now = now || new Date();
    return now.getMonth() + 1 === player.birthday.month && now.getDate() === player.birthday.day;
}

// Single O(n) pass: compute all row classes at once and return as an array.
// Replaces the old O(n¬≤) recursive approach that looped back through
// all previous players for every single row.
function computeRowClasses(playersArray) {
    const classes = [];
    const hasLiveData = playersArray.some(p => p.currentAvg !== null && !isNaN(p.currentAvg));

    if (!hasLiveData) {
        // Pre-season: simple alternation
        return playersArray.map((_, i) => i % 2 === 0 ? 'first-place' : 'second-place');
    }

    let blockParity = 0; // 0 = first-place (black), 1 = second-place (blue)

    for (let i = 0; i < playersArray.length; i++) {
        if (i === 0) {
            classes.push('first-place');
            continue;
        }

        const curDist  = playersArray[i].distanceFrom200;
        const prevDist = playersArray[i - 1].distanceFrom200;
        const isTBD     = curDist  >= 999;
        const prevIsTBD = prevDist >= 999;

        if (isTBD && prevIsTBD) {
            // Consecutive TBD rows alternate individually
            classes.push(classes[i - 1] === 'first-place' ? 'second-place' : 'first-place');
        } else if (!isTBD && !prevIsTBD && Math.abs(curDist - prevDist) < 0.0001) {
            // Same distance block as previous ‚Äî same color
            classes.push(classes[i - 1]);
        } else {
            // New distance block ‚Äî flip parity
            blockParity = 1 - blockParity;
            classes.push(blockParity === 0 ? 'first-place' : 'second-place');
        }
    }

    return classes;
}

function renderPlayers(now) {
    now = now || new Date();
    const container = document.getElementById('standings-container');

    // Check if we're during World Baseball Classic (March 5-17, 2026)
    const wbcStart = SEASON.wbcStart;
    const wbcEnd   = SEASON.wbcEnd;
    const isWBC = now >= wbcStart && now <= wbcEnd;

    // Determine who gets the diamond (‚¨•)
    let diamondPlayerId = null;
    const playersWithData = playersArray.filter(p => p.liveAtBats !== null && p.liveAtBats > 0);

    if (playersWithData.length > 0) {
        const playersOver200 = playersWithData.filter(p => p.liveAtBats >= 200);

        if (playersOver200.length > 0) {
            let closestPlayer = playersOver200[0];
            let closestDistance = calculateDistanceFrom200(closestPlayer.currentAvg);
            for (let player of playersOver200) {
                const distance = calculateDistanceFrom200(player.currentAvg);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestPlayer = player;
                }
            }
            diamondPlayerId = closestPlayer.id;
        } else {
            let mostABPlayer = playersWithData[0];
            for (let player of playersWithData) {
                if (player.liveAtBats > mostABPlayer.liveAtBats) mostABPlayer = player;
            }
            diamondPlayerId = mostABPlayer.id;
        }
    }

    // Check if the current DOM order matches the desired player order.
    // If it does, skip the full rebuild and just patch stats in place to avoid flash.
    const existingRows = Array.from(container.querySelectorAll('.player-row'));
    const orderMatches = existingRows.length === playersArray.length &&
        playersArray.every((p, i) => existingRows[i] &&
            parseInt(existingRows[i].getAttribute('data-player-id')) === p.id);

    if (orderMatches) {
        // In-place update: only touch the text nodes that may have changed
        const rowClasses = computeRowClasses(playersArray);
        playersArray.forEach((player, index) => {
            const row = existingRows[index];
            const newRowClass = `player-row ${rowClasses[index]}`;
            if (row.className !== newRowClass) row.className = newRowClass;

            const avgEl = row.querySelector('.batting-average');
            const abEl  = row.querySelector('.tap-tooltip');

            if (player.currentAvg !== null && !isNaN(player.currentAvg)) {
                const avgText = player.currentAvg.toFixed(3);
                const abText  = `${player.liveAtBats || 0}AB`;
                if (avgEl && avgEl.textContent !== avgText) avgEl.textContent = avgText;
                if (abEl  && abEl.textContent  !== abText)  abEl.textContent  = abText;
            }

            // Update diamond indicator on name
            const nameEl = row.querySelector('.player-name');
            if (nameEl) {
                const hasDiamond = nameEl.textContent.includes('‚¨•');
                const wantsDiamond = player.id === diamondPlayerId;
                if (wantsDiamond && !hasDiamond) nameEl.innerHTML += '‚¨•';
                if (!wantsDiamond && hasDiamond) {
                    nameEl.innerHTML = nameEl.innerHTML.replace('‚¨•', '');
                }
                // Birthday cake
                const hasCake = nameEl.textContent.includes('üéÇ');
                const wantsCake = isBirthday(player, now);
                if (wantsCake && !hasCake) nameEl.innerHTML += ' <span style="margin-left:0.2em;">üéÇ</span>';
                if (!wantsCake && hasCake) nameEl.innerHTML = nameEl.innerHTML.replace(/ <span style="margin-left:0.2em;">üéÇ<\/span>/g, '').replace(' üéÇ', '').replace('üéÇ', '');
            }
        });
        return;
    }

    // Order changed (or first render) ‚Äî full rebuild
    container.innerHTML = '';
    const rowClasses = computeRowClasses(playersArray);

    playersArray.forEach((player, index) => {
        const rowClass = rowClasses[index];

        let avgDisplay = '.---';
        let atBatsDisplay = '---AB';

        if (player.currentAvg !== null && !isNaN(player.currentAvg)) {
            avgDisplay = player.currentAvg.toFixed(3);
            atBatsDisplay = `${player.liveAtBats || 0}AB`;
        }

        let displayName = '';
        const isTBD = player.name.startsWith('SOON COME');

        if (player.number) {
            displayName += `<span class="player-number"><span>${player.number}</span></span>`;
        } else {
            displayName += `<span class="player-number"><span></span></span>`;
        }

        if (isTBD) {
            displayName += `<span class="tbd-text">${player.name}</span>`;
        } else {
            const selectedIds = getSelectedBatters();
            const isSelectedPlayer = selectedIds.includes(player.id);
            const horseSuffix = isSelectedPlayer ? '<span class="player-horse" style="margin-left:0.3em;">ìÉó</span>' : '';
            displayName += `<span class="player-name-text">${player.name}</span>${horseSuffix}`;
        }

        if (isWBC && player.wbcFlag) displayName += ' ' + player.wbcFlag;
        if (player.id === diamondPlayerId) displayName += '‚¨•';
        if (isBirthday(player, now)) displayName += ' <span style="margin-left:0.2em;">üéÇ</span>';

        const row = document.createElement('div');
        row.className = `player-row ${rowClass}`;
        row.setAttribute('data-player-id', player.id);

        const nameClass = isTBD ? 'player-name tbd-line' : 'player-name';

        row.innerHTML = `
            <div class="player-info">
                <div class="${nameClass}" role="button" tabindex="0" aria-label="View ${player.fullName || player.name} details">${displayName}</div>
                <div class="batting-stats">
                    <div class="batting-display" role="button" tabindex="0" aria-label="Toggle at-bats for ${player.fullName || player.name}">
                        <div class="batting-average">${avgDisplay}</div>
                        <div class="tap-tooltip">${atBatsDisplay}</div>
                    </div>
                </div>
            </div>
        `;

        container.appendChild(row);
    });
}

function attachEventListeners() {
    const container = document.getElementById('standings-container');

    // Use event delegation ‚Äî listeners live on the container, not on each row.
    // This means they only need to be attached once and survive re-renders.
    container.addEventListener('click', handleContainerInteraction);
    container.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') handleContainerInteraction(e);
    });

    function handleContainerInteraction(e) {
        const nameEl = e.target.closest('.player-name');
        if (nameEl) {
            e.preventDefault();
            e.stopPropagation();
            const playerId = parseInt(nameEl.closest('.player-row').getAttribute('data-player-id'));
            openPlayerModal(playerId);
            return;
        }

        const battingEl = e.target.closest('.batting-display');
        if (battingEl) {
            e.preventDefault();
            e.stopPropagation();
            battingEl.classList.toggle('active');
            return;
        }

        // Clicked inside container but not on a batting display ‚Äî deactivate all
        document.querySelectorAll('.batting-display').forEach(d => d.classList.remove('active'));
    }

    container.addEventListener('touchend', function (e) {
        const battingEl = e.target.closest('.batting-display');
        if (battingEl) {
            e.preventDefault();
            e.stopPropagation();
            battingEl.classList.toggle('active');
            return;
        }
        document.querySelectorAll('.batting-display').forEach(d => d.classList.remove('active'));
    });

    // Clicks outside the container also deactivate batting tooltips
    document.addEventListener('click', function (e) {
        if (!e.target.closest('#standings-container')) {
            document.querySelectorAll('.batting-display').forEach(d => d.classList.remove('active'));
        }
    });

    document.addEventListener('touchend', function (e) {
        if (!e.target.closest('#standings-container')) {
            document.querySelectorAll('.batting-display').forEach(d => d.classList.remove('active'));
        }
    });
}

// League designation now lives in playerData[id].league ‚Äî no separate lookup needed

function openPlayerModal(playerId) {
    const player = playerData[playerId];
    if (!player) return;
    
    const modal = document.getElementById('player-modal');
    const nameEl = document.getElementById('player-modal-name');
    const numberEl = document.getElementById('player-modal-number');
    const positionEl = document.getElementById('player-modal-position');
    
    // Use fullName for modal
    const displayName = player.fullName || player.name;
    
    // Populate the diamond number separately
    if (player.number) {
        numberEl.innerHTML = '<span class="player-number"><span>' + player.number + '</span></span>';
    } else {
        numberEl.innerHTML = '<span class="player-number"><span></span></span>';
    }
    
    // Populate the position badge
    if (player.position) {
        positionEl.innerHTML = '<span class="player-position"><span>' + player.position + '</span></span>';
    } else {
        positionEl.innerHTML = '';
    }
    
    // Convert name to uppercase
    const upperDisplayName = displayName.toUpperCase();
    
    // Build name content (no diamond here)
    let htmlContent = '';
    
    if (player.url && player.url !== '') {
        nameEl.style.cursor = 'pointer';
        nameEl.onclick = function() { window.open(player.url, '_blank'); };
        
        // Parse out suffixes like (AL) or , Jr.
        const match = displayName.match(/^(.+?)(,\s*Jr\.|,\s*Sr\.|,\s*III|,\s*IV|\s+\(.+\))?$/);
        if (match) {
            const name = match[1].toUpperCase();  // Main name without suffix (uppercase)
            const suffix = match[2] ? match[2].toUpperCase() : '';  // Suffix like ", Jr." or " (AL)" (uppercase)
            htmlContent += '<u>' + name + '</u>' + suffix;
        } else {
            htmlContent += '<u>' + upperDisplayName + '</u>';
        }
    } else {
        nameEl.style.cursor = 'default';
        nameEl.onclick = null;
        htmlContent += upperDisplayName;
    }
    
    nameEl.innerHTML = htmlContent;
    
    document.getElementById('player-modal-details').innerHTML =
        'Age: ' + player.age + ' | Height: ' + player.height + ' | Weight: ' + player.weight;
    
    if (player.battingAvg2025 === '*') {
        document.getElementById('player-modal-2025-stats').innerHTML = 
            '<strong>2025* Batting Avg./At Bats: ' + player.battingAvgValue + '</strong>';
    } else {
        document.getElementById('player-modal-2025-stats').innerHTML = 
            '<strong>2025 Batting Avg./At Bats: ' + player.battingAvg2025 + '</strong>';
    }
    
    document.getElementById('player-modal-2026-stats').innerHTML = 
        '<strong>2026 PECOTA Projection: ' + player.pecota2026 + '</strong>';
    
    document.getElementById('player-modal-current-stats').innerHTML = 
        '<strong>Current Stats: <span id="player-current-stats">.---/---AB</span></strong>';
    
    if (player.games) {
        document.getElementById('player-modal-games').textContent = '*' + player.games;
    } else {
        document.getElementById('player-modal-games').textContent = '';
    }
    
    const screwDiv = document.getElementById('player-modal-screw');
    if (player.bio && player.bio.trim() !== '') {
        screwDiv.innerHTML = player.bio;
    } else {
        screwDiv.textContent = 'SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME SOON COME';
    }
    
    // Fetch player status & trend
    fetchPlayerStatusAndTrend(playerId);
    
    // Update current stats from playersArray
    const playerObj = playersArray.find(p => p.id === playerId);
    const currentStatsEl = document.getElementById('player-current-stats');
    if (playerObj && playerObj.currentAvg !== null && playerObj.liveAtBats !== null) {
        const avgDisplay = playerObj.currentAvg.toFixed(3);
        const abDisplay = `${playerObj.liveAtBats}AB`;
        currentStatsEl.textContent = `${avgDisplay}/${abDisplay}`;
    } else {
        currentStatsEl.textContent = '.---/---AB';
    }
    
    // Set team designation
    const teamDesignationEl = document.getElementById('player-team-designation');
    teamDesignationEl.innerHTML = player.league || '';

    // Update select batter button state
    currentModalPlayerId = playerId;
    updateSelectBatterUI(playerId);

    openModalWithScroll(modal);
}

// Status and trend are now populated by fetchMLBStats ‚Äî no separate API call needed
function fetchPlayerStatusAndTrend(playerId) {
    const player   = playerData[playerId];
    const playerObj = playersArray.find(p => p.id === playerId);
    const statusEl = document.getElementById('player-status');
    const trendEl  = document.getElementById('player-trend');

    const now = new Date();
    if (now < SEASON.springTraining) {
        statusEl.textContent = 'WINTER';
        trendEl.textContent  = '---';
        return;
    }
    if (now < SEASON.openingDay) {
        statusEl.textContent = 'SPRING';
        trendEl.textContent  = '---';
        return;
    }
    if (!player.mlbId) {
        statusEl.textContent = 'TBD';
        trendEl.textContent  = '---';
        return;
    }

    statusEl.textContent = playerObj?.rosterStatus || '---';
    trendEl.textContent  = playerObj?.trend        || '---';
}

function formatStamp(date) {
    const mon  = date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
    const dd   = String(date.getDate()).padStart(2, '0');
    const yyyy = date.getFullYear();
    // Force seconds to :11 always
    const h    = date.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    // Replace the seconds with :11
    const stamp11 = h.replace(/(\d{1,2}:\d{2})/, '$1:11');
    return `${mon} ${dd}, ${yyyy} ${stamp11.toUpperCase()}`;
}

let _diamondClockInterval = null;

function startDiamondClock() {
    const el = document.getElementById('diamond-modal-last-update');
    if (!el) return;
    // Update immediately then every 60s
    el.textContent = formatStamp(new Date());
    _diamondClockInterval = setInterval(() => {
        el.textContent = formatStamp(new Date());
    }, 60000);
}

function stopDiamondClock() {
    if (_diamondClockInterval) {
        clearInterval(_diamondClockInterval);
        _diamondClockInterval = null;
    }
}

function updateDiamondModalStamp() {
    const el = document.getElementById('diamond-modal-last-update');
    if (!el) return;
    const now = new Date();
    if (now < SEASON.openingDay) {
        // Pre-season: show Opening Day first pitch time, static
        el.textContent = formatStamp(OPENING_DAY_FIRST_PITCH);
    } else {
        // Season active: show current time (updated by live clock when modal is open)
        el.textContent = formatStamp(now);
    }
}

function showLoadingState() {
    if (new Date() < SEASON.openingDay) return;

    document.getElementById('loading-banner').classList.add('visible');
    document.querySelectorAll('.batting-display').forEach(el => el.classList.add('is-loading'));
}

function triggerBounceDiamonds() {
    const header = document.querySelector('.header');
    if (!header) return;
    header.classList.remove('wave-bounce');
    void header.offsetWidth; // force reflow to restart animation
    header.classList.add('wave-bounce');
    // Remove after last diamond finishes (0.75s delay + 11s duration)
    setTimeout(() => header.classList.remove('wave-bounce'), 11800);
}

function hideLoadingState() {
    document.getElementById('loading-banner').classList.remove('visible');
    document.querySelectorAll('.batting-display').forEach(el => el.classList.remove('is-loading'));
    updateDiamondModalStamp();
    if (new Date() >= SEASON.openingDay) triggerBounceDiamonds();
}
async function fetchMLBStats() {
    const playersWithIds = playersArray.filter(p => p.mlbId);

    showLoadingState();
    const now = new Date();
    const isSpringTraining = now >= SEASON.springTraining && now < SEASON.openingDay;

    await Promise.all(playersWithIds.map(async player => {
        try {
            // Request season stats + currentTeam + gameLog in a single API call
            // Spring training stats live in a separate bucket from regular season
            const statTypes = isSpringTraining
                ? 'type=[springTraining,season,gameLog]'
                : 'type=[season,gameLog]';

            const response = await fetch(
                `https://statsapi.mlb.com/api/v1/people/${player.mlbId}?hydrate=currentTeam,stats(group=[hitting],${statTypes},season=${SEASON.year})`
            );

            if (!response.ok) return;

            const data   = await response.json();
            const person = data.people[0];

            // ‚îÄ‚îÄ Batting stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (person.stats && person.stats.length > 0) {
                const statTypeName = isSpringTraining ? 'springTraining' : 'season';
                const hittingStats = person.stats.find(s =>
                    s.group.displayName === 'hitting' && s.type.displayName === statTypeName
                ) || person.stats.find(s =>
                    s.group.displayName === 'hitting' && s.type.displayName === 'season'
                );

                if (hittingStats && hittingStats.splits && hittingStats.splits.length > 0) {
                    const stats = hittingStats.splits[0].stat;
                    player.currentAvg      = parseFloat(stats.avg) || 0;
                    player.liveAtBats      = stats.atBats || 0;
                    player.liveHits        = stats.hits || 0;
                    player.distanceFrom200 = calculateDistanceFrom200(player.currentAvg);
                }

                // Pull current age from API if available
                if (person.currentAge) {
                    player.age       = person.currentAge;
                    player.ageIsLive = true;
                }

                // ‚îÄ‚îÄ Trend from game log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const gameLog = person.stats.find(s => s.type.displayName === 'gameLog');
                if (gameLog && gameLog.splits) {
                    const recentGames = gameLog.splits.filter(g => g.stat && g.stat.atBats > 0).slice(0, 2);
                    if (recentGames.length >= 2) {
                        const lastAvg = recentGames[0].stat.hits / recentGames[0].stat.atBats;
                        const prevAvg = recentGames[1].stat.hits / recentGames[1].stat.atBats;
                        player.trend = lastAvg > prevAvg ? 'AVG‚Üë' : lastAvg < prevAvg ? 'AVG‚Üì' : 'AVG‚Üí';
                    } else {
                        player.trend = '---';
                    }
                }
            }

            // ‚îÄ‚îÄ Roster status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (person.currentTeam) {
                player.currentTeamId = person.currentTeam.id;
                const sportId  = person.currentTeam.sport?.id;
                const isMLB    = sportId === 1;
                const isMinors = sportId >= 11 && sportId <= 16;

                if (isMLB) {
                    const rosterStatus = person.rosterStatus?.code || person.status?.code;
                    player.rosterStatus = (rosterStatus === 'D60' || rosterStatus === 'D10' || rosterStatus === 'D7')
                        ? 'INJURED' : 'ACTIVE';
                } else if (isMinors) {
                    const t = (person.currentTeam.name || '').toUpperCase();
                    player.rosterStatus = t.includes('AAA') || t.includes('TRIPLE') ? 'AAA'
                        : t.includes('AA') || t.includes('DOUBLE') ? 'AA'
                        : t.includes('A+') || t.includes('HIGH') ? 'A+'
                        : 'A';
                } else if (person.currentTeam.name) {
                    const t = person.currentTeam.name.toUpperCase();
                    player.rosterStatus = t.includes('AAA') || t.includes('TRIPLE') ? 'AAA'
                        : t.includes('AA') || t.includes('DOUBLE') ? 'AA'
                        : t.includes('A+') || t.includes('HIGH') ? 'A+'
                        : t.includes('INDEPENDENT') || t.includes('INDY') ? 'IND'
                        : 'ACTIVE';
                } else {
                    player.rosterStatus = 'FREE AGENT';
                }
            } else {
                player.rosterStatus = 'FREE AGENT';
            }

        } catch (err) {
            console.error(`Error fetching stats for ${player.name}:`, err);
        }
    }));

    rankPlayers(now);
    renderPlayers(now);
    applySelectedBatterStyles();
    hideLoadingState();

    // Re-schedule next fetch at the next :11 if still in an active mode
    if (_statsRefreshMode) scheduleNextElevenFetch(_statsRefreshMode);
}

initializePlayers();
attachEventListeners(); // Set once ‚Äî uses event delegation, survives re-renders
updateDiamondModalStamp(); // Set pre-season or last-update label immediately
if (new Date() >= SEASON.openingDay) {
    fetchMLBStats();
}

// ============================================================
// WAVE ANIMATION + SMART REFRESH CONTROLLER
//
// Pre-season:          wave always on, no stats fetching
// Games upcoming:      wave on, fetch every 5 minutes
// Games live:          wave on, fetch every 11 seconds
// All games final:     wave off, stop fetching until tomorrow
// No games today:      wave off, stop fetching until tomorrow
// ============================================================
const waveHeader = document.querySelector('.header');

// Refresh interval handle ‚Äî kept module-level so it can be cleared/reset
let _statsRefreshTimer = null;
let _statsRefreshMode  = null; // 'live' | 'pending' | null

function setWave(on) {
    if (on) { waveHeader.classList.add('wave-active'); }
    else     { waveHeader.classList.remove('wave-active'); }
}

function scheduleNextElevenFetch(mode) {
    // Cancel any existing timer
    if (_statsRefreshTimer) { clearTimeout(_statsRefreshTimer); _statsRefreshTimer = null; }
    if (mode === null) { _statsRefreshMode = null; return; }
    _statsRefreshMode = mode;

    const now     = new Date();
    const sec     = now.getSeconds();
    const ms      = now.getMilliseconds();

    // During live games: fire every minute at :11
    // During pending:    fire every minute at :11
    // Both use the same cadence ‚Äî "on the elevens"
    const secsUntil11 = sec < 11 ? (11 - sec) : (60 - sec + 11);
    const msUntilNext = secsUntil11 * 1000 - ms;

    _statsRefreshTimer = setTimeout(() => {
        if (!document.hidden) fetchMLBStats();
        // fetchMLBStats calls updateWaveAndRefresh at the end which re-schedules
    }, msUntilNext);
}

function setRefreshInterval(mode) {
    scheduleNextElevenFetch(mode);
}

async function updateWaveAndRefresh() {
    const now        = new Date();
    const openingDay = SEASON.openingDay;

    // Pre-season: continuous wave on, no fetching
    if (now < openingDay) {
        setWave(true);
        setRefreshInterval(null);
        return;
    }

    // Season active: never use wave-active (bounces happen on fetch instead)
    setWave(false);

    // Season active: check MLB schedule for today's games involving our batters' teams
    try {
        const todayET = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const yyyy    = todayET.getFullYear();
        const mm      = String(todayET.getMonth() + 1).padStart(2, '0');
        const dd      = String(todayET.getDate()).padStart(2, '0');
        const dateStr = `${yyyy}-${mm}-${dd}`;

        const schedRes = await fetch(
            `https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${dateStr}&hydrate=linescore,team`
        );
        if (!schedRes.ok) return; // leave current state unchanged on error

        const schedData = await schedRes.json();
        const games     = schedData.dates?.[0]?.games || [];

        if (games.length === 0) {
            // Off day ‚Äî no games at all
            setWave(false);
            setRefreshInterval(null);
            return;
        }

        const ourTeamIds = new Set(playersArray.map(p => p.currentTeamId).filter(Boolean));

        if (ourTeamIds.size === 0) {
            setWave(false);
            setRefreshInterval(null);
            return;
        }

        const ourGames = games.filter(g => {
            const homeId = g.teams?.home?.team?.id;
            const awayId = g.teams?.away?.team?.id;
            return ourTeamIds.has(homeId) || ourTeamIds.has(awayId);
        });

        if (ourGames.length === 0) {
            // None of our players' teams are playing today
            setWave(false);
            setRefreshInterval(null);
            return;
        }

        const liveStates  = new Set(['In Progress', 'Manager Challenge', 'Delayed', 'Suspended', 'Delayed: Rain']);
        const anyLive     = ourGames.some(g => liveStates.has(g.status?.detailedState));
        const anyUpcoming = ourGames.some(g => g.status?.abstractGameState === 'Preview');
        const anyActive   = anyLive || anyUpcoming;

        setWave(anyActive);

        if (anyLive) {
            // At least one game in progress ‚Äî fetch on the elevens
            setRefreshInterval('live');
        } else if (anyUpcoming) {
            // Games later today but none live yet ‚Äî fetch on the elevens
            setRefreshInterval('pending');
        } else {
            // All our games are final for the day
            setWave(false);
            setRefreshInterval(null);
        }

    } catch (err) {
        console.warn('Schedule check failed:', err);
        // Leave current wave + interval state unchanged on network error
    }
}

// Check schedule every 60 seconds to catch game starts/endings promptly
updateWaveAndRefresh();
setInterval(updateWaveAndRefresh, 60 * 1000);

// updateSeasonSubtitle was removed ‚Äî week label is handled by the IIFE above

// Pause background fetches when tab is hidden, resume when visible
// When tab becomes visible, re-check schedule and fetch immediately if in season
document.addEventListener('visibilitychange', function () {
    if (!document.hidden && new Date() >= SEASON.openingDay) {
        updateWaveAndRefresh();
        fetchMLBStats();
    }
});

const favIcon = document.createElement('link');
favIcon.rel = 'icon';
favIcon.href = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2225%22 y=%2225%22 width=%2250%22 height=%2250%22 fill=%22%23c5e5f0%22 transform=%22rotate(45 50 50)%22/></svg>';
document.head.appendChild(favIcon);

// ============================================================
// SELECTED BATTERS ‚Äî localStorage persistence
// ============================================================

function getSelectedBatters() {
    try {
        return JSON.parse(localStorage.getItem('selectedBatters') || '[]');
    } catch { return []; }
}

function saveSelectedBatters(ids) {
    try {
        localStorage.setItem('selectedBatters', JSON.stringify(ids));
    } catch (e) {
        console.warn('localStorage not available:', e);
    }
}

function isSelected(playerId) {
    return getSelectedBatters().includes(playerId);
}

let currentModalPlayerId = null;

function updateSelectBatterUI(playerId) {
    const diamond = document.getElementById('select-batter-diamond');
    const label   = document.getElementById('select-batter-label');
    if (!diamond || !label) return;
    if (isSelected(playerId)) {
        diamond.style.background = 'currentColor';
        label.style.fontStyle = 'italic';
        label.textContent = 'DESELECT BATTER';
    } else {
        diamond.style.background = 'transparent';
        label.style.fontStyle = 'normal';
        label.textContent = 'SELECT BATTER';
    }
}

function toggleSelectBatter() {
    if (currentModalPlayerId === null) return;
    const ids = getSelectedBatters();
    const idx = ids.indexOf(currentModalPlayerId);
    if (idx === -1) {
        ids.push(currentModalPlayerId);
    } else {
        ids.splice(idx, 1);
    }
    saveSelectedBatters(ids);
    updateSelectBatterUI(currentModalPlayerId);
    // Re-render leaderboard names to reflect italic change
    applySelectedBatterStyles();
}

function applySelectedBatterStyles() {
    const ids = getSelectedBatters();
    document.querySelectorAll('.player-row').forEach(row => {
        const playerId = parseInt(row.getAttribute('data-player-id'));
        const nameTextEl = row.querySelector('.player-name-text');
        const numberEl = row.querySelector('.player-number');
        if (!nameTextEl) return;
        if (ids.includes(playerId)) {
            if (!row.querySelector('.player-horse')) {
                const horseSpan = document.createElement('span');
                horseSpan.className = 'player-horse';
                horseSpan.style.marginLeft = '0.3em';
                horseSpan.textContent = 'ìÉó';
                nameTextEl.insertAdjacentElement('afterend', horseSpan);
            }
        } else {
            nameTextEl.style.fontStyle = '';
            const horseSpan = row.querySelector('.player-horse');
            if (horseSpan) horseSpan.remove();
        }
    });
}


let modalScrollOffset = 0;

function openModalWithScroll(modal) {
    modalScrollOffset = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
    modal.classList.add('open');
    document.body.style.position = 'fixed';
    document.body.style.top = `-${modalScrollOffset}px`;
    document.body.style.width = '100%';
    document.body.style.overflow = 'hidden';
}

function closeModalWithScroll(modal) {
    modal.classList.remove('open');
    const scrollPosition = modalScrollOffset;
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    document.body.style.overflow = '';
    window.scrollTo(0, scrollPosition);
    modalScrollOffset = 0;
}

document.addEventListener('DOMContentLoaded', function () {
    const rulesModal = document.getElementById('rules-modal');
    const playerModal = document.getElementById('player-modal');
    const contactModal = document.getElementById('contact-modal');
    const rulesTrigger = document.getElementById('rules-trigger');
    const contactTrigger = document.getElementById('contact-trigger');

    // Select Batter button
    const selectBatterBtn = document.getElementById('select-batter-btn');
    if (selectBatterBtn) {
        selectBatterBtn.addEventListener('click', toggleSelectBatter);
        selectBatterBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            toggleSelectBatter();
        });
    }
    
    // Mendoza Line Wikipedia ‚Äî open in new tab
    const mendozaLineTrigger = document.getElementById('mendoza-line-trigger');
    if (mendozaLineTrigger) {
        mendozaLineTrigger.addEventListener('click', function() {
            window.open('https://en.wikipedia.org/wiki/Mendoza_Line', '_blank');
        });
    }

    rulesTrigger.addEventListener('click', function (e) {
        e.preventDefault();
        openModalWithScroll(rulesModal);
    });
    
    contactTrigger.addEventListener('click', function (e) {
        e.preventDefault();
        openModalWithScroll(contactModal);
    });
    
    document.querySelectorAll('.close').forEach(btn => {
        btn.addEventListener('click', function () {
            const modalType = this.getAttribute('data-modal');
            if (modalType === 'rules') {
                closeModalWithScroll(rulesModal);
            } else if (modalType === 'player') {
                closeModalWithScroll(playerModal);
            } else if (modalType === 'contact') {
                closeModalWithScroll(contactModal);
            } else if (modalType === 'horse') {
                closeModalWithScroll(document.getElementById('horse-modal'));
            } else if (modalType === 'diamond') {
                stopDiamondClock();
                closeModalWithScroll(document.getElementById('diamond-modal'));
            }
        });
    });
    
    // Diamond trigger buttons
    const diamondModal = document.getElementById('diamond-modal');
    ['diamond-trigger', 'diamond-trigger-2'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.addEventListener('click', function (e) {
                e.stopPropagation();
                updateDiamondModalStamp();
                openModalWithScroll(diamondModal);
                if (new Date() >= SEASON.openingDay) startDiamondClock();
            });
        }
    });

    // Tap anywhere on screen closes the diamond modal
    diamondModal.addEventListener('click', function () {
        stopDiamondClock();
        closeModalWithScroll(diamondModal);
    });

    window.addEventListener('click', function (event) {
        if (event.target == rulesModal) {
            closeModalWithScroll(rulesModal);
        }
        if (event.target == playerModal) {
            closeModalWithScroll(playerModal);
        }
        const horseModal = document.getElementById('horse-modal');
        if (event.target == horseModal) {
            closeModalWithScroll(horseModal);
        }
        if (event.target == diamondModal) {
            stopDiamondClock();
            closeModalWithScroll(diamondModal);
        }
    });
    
    // Escape key closes whichever modal is currently open
    document.addEventListener('keydown', function (e) {
        if (e.key !== 'Escape') return;
        const openModal = document.querySelector('.modal.open');
        if (openModal) {
            if (openModal.id === 'diamond-modal') stopDiamondClock();
            closeModalWithScroll(openModal);
        }
    });

    document.getElementById('contact-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const submitBtn = this.querySelector('.contact-submit-btn');
        const form = this;
        submitBtn.textContent = "& THEY'RE OFF!!";
        submitBtn.disabled = true;

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'Accept': 'application/json' }
            });

            if (response.ok) {
                form.innerHTML = '<p style="text-align:center; font-weight:bold; margin-top: 20px;">Message received! Your loyal Commissioner will be in touch.</p>';
            } else {
                submitBtn.textContent = 'SEND MESSAGE';
                submitBtn.disabled = false;
                const errMsg = document.createElement('p');
                errMsg.style.cssText = 'color:red; text-align:center; margin-top:10px; font-size:0.85rem;';
                errMsg.textContent = 'Something went wrong. Please try again or email the Commissioner directly.';
                form.appendChild(errMsg);
            }
        } catch (err) {
            submitBtn.textContent = 'SEND MESSAGE';
            submitBtn.disabled = false;
            const errMsg = document.createElement('p');
            errMsg.style.cssText = 'color:red; text-align:center; margin-top:10px; font-size:0.85rem;';
            errMsg.textContent = 'Network error. Check your connection and try again.';
            form.appendChild(errMsg);
        }
    });
});

// Pre-compute timestamps for updateCountdown ‚Äî no need to rebuild every second
const COUNTDOWN_TARGETS = {
    springTraining:    SEASON.springTraining.getTime(),
    openingDay:        SEASON.openingDay.getTime(),
    allStarBreakStart: SEASON.allStarBreakStart.getTime(),
    allStarBreakEnd:   SEASON.allStarBreakEnd.getTime(),
    finishLine:        SEASON.finishLine.getTime(),
};

function updateCountdown() {
    const now = new Date().getTime();
    const { springTraining, openingDay, allStarBreakStart, allStarBreakEnd, finishLine } = COUNTDOWN_TARGETS;

    let targetDate, labelText;

    if (now < springTraining) {
        targetDate = springTraining;
        labelText  = "'TIL SPRING";
    } else if (now < openingDay) {
        targetDate = openingDay;
        labelText  = "'TIL POST TIME";
    } else if (now < allStarBreakStart) {
        targetDate = allStarBreakStart;
        labelText  = "TO THE BREAK";
    } else if (now < allStarBreakEnd) {
        targetDate = allStarBreakEnd;
        labelText  = "'TIL THE 2nd HALF";
    } else if (now < finishLine) {
        targetDate = finishLine;
        labelText  = "TO THE FINISH LINE";
    } else {
        document.getElementById('live-indicator').innerHTML =
            '<span id="countdown-timer">00:00:00:00</span> SEASON COMPLETE';
        return;
    }

    const distance = targetDate - now;
    if (distance < 0) {
        document.getElementById('countdown-timer').textContent = '00:00:00:00';
        return;
    }

    const days    = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours   = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    const formatted = String(days).padStart(2, '0')    + ':' +
                      String(hours).padStart(2, '0')   + ':' +
                      String(minutes).padStart(2, '0') + ':' +
                      String(seconds).padStart(2, '0');

    document.getElementById('live-indicator').innerHTML =
        '<span id="countdown-timer">' + formatted + '</span> ' + labelText;
}

updateCountdown();
setInterval(updateCountdown, 1000);

const staticMessages = [
    'Next Race: Mar 25 ‚Äì Sept 27',
    'Our 11th "Glorious" Season',
    '"Congratulations" to 2025 Champ D. Moore',
    'It\'s the 3rd Race to Two Hundred!',
    'R.I.P. Mister Baseball',
    'Diamond Life',
    'Diamond Life!!!!!!!!!!!',
    'Your Perfect Fantasy',
    'Mario\'s Eleventh Affair'
];

let lastMessage = localStorage.getItem('lastMessage') || '';
let randomIndex;
let newMessage;

do {
    randomIndex = Math.floor(Math.random() * staticMessages.length);
    newMessage = staticMessages[randomIndex];
} while (newMessage === lastMessage);

localStorage.setItem('lastMessage', newMessage);

// Call to the Post bugle sound effect
const bugleTrigger = document.getElementById('bugle-trigger');
if (bugleTrigger) {
    bugleTrigger.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const now = audioContext.currentTime;
        
        // Function to play a note - racetrack bugle sound
        function playNote(freq, startTime, duration) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            
            // Sawtooth wave for bright, tinny quality
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(freq, startTime);
            
            // High-pass filter for metallic resonance
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(1200, startTime);
            filter.Q.setValueAtTime(2, startTime);
            
            // Volume envelope
            gain.gain.setValueAtTime(0, startTime); // Start at 0
            gain.gain.linearRampToValueAtTime(0.75, startTime + 0.05); // Quick attack to 0.75 over 0.05s
            gain.gain.setValueAtTime(0.7, startTime + 0.05); // Sustain at 0.7
            gain.gain.setValueAtTime(0.7, startTime + (duration * 0.8)); // Hold for 80% of duration
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration); // Decay to end
            
            // Connect: oscillator -> filter -> gain -> destination
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.start(startTime);
            osc.stop(startTime + duration);
        }
        
        // Notes for racetrack melody
        const C4 = 261.63;  // C4 (low C)
        const F4 = 349.23;  // F4
        const A4 = 440.00;  // A4
        const C5 = 523.25;  // C5 (high C)
        
        let t = now;
        
        // First phrase: F A CCC [pause] AAA [pause] FAFC (C goes DOWN)
        playNote(F4, t, 0.3);
        t += 0.3;
        playNote(A4, t, 0.3);
        t += 0.3;
        playNote(C5, t, 0.2);
        t += 0.2;
        playNote(C5, t, 0.2);
        t += 0.2;
        playNote(C5, t, 0.3);
        t += 0.3;
        t += 0.2; // pause
        playNote(A4, t, 0.2);
        t += 0.2;
        playNote(A4, t, 0.2);
        t += 0.2;
        playNote(A4, t, 0.3);
        t += 0.3;
        t += 0.2; // pause
        playNote(F4, t, 0.2);
        t += 0.2;
        playNote(A4, t, 0.2);
        t += 0.2;
        playNote(F4, t, 0.2);
        t += 0.2;
        playNote(C4, t, 0.3);  // C goes DOWN to C4
        t += 0.3;
        t += 0.4; // double pause
        
        // Second phrase: F A CCC [pause] AAA [pause] CCCF (Cs are LOW C4, F goes UP)
        playNote(F4, t, 0.3);
        t += 0.3;
        playNote(A4, t, 0.3);
        t += 0.3;
        playNote(C5, t, 0.2);
        t += 0.2;
        playNote(C5, t, 0.2);
        t += 0.2;
        playNote(C5, t, 0.3);
        t += 0.3;
        t += 0.2; // pause
        playNote(A4, t, 0.2);
        t += 0.2;
        playNote(A4, t, 0.2);
        t += 0.2;
        playNote(A4, t, 0.3);
        t += 0.3;
        t += 0.2; // pause
        playNote(C4, t, 0.2);  // LOW C4
        t += 0.2;
        playNote(C4, t, 0.2);  // LOW C4
        t += 0.2;
        playNote(C4, t, 0.2);  // LOW C4
        t += 0.2;
        playNote(F4, t, 0.4);  // F goes UP
        t += 0.4;
        
        // Calculate total song duration
        const totalDuration = t - now;
        
        // For setTimeout timing, use a fixed 7.2 second delay (7200ms) instead of audio timing
        const raceStartDelay = 7200; // Race starts 700ms after "they're OFF" at 6500ms
        
        // Open horse animation modal
        const horseModal = document.getElementById('horse-modal');
        openModalWithScroll(horseModal);
        
        // Fetch live data from API
        fetch('/api/mendoza-stakes-data')
            .then(response => response.json())
            .then(apiData => {
                // API should return:
                // {
                //   horses: [{number, id, name, atBats, avg, distanceFrom200}, ...],
                //   currentDate: "2026-07-26T15:00:00",
                //   gameDay: 123,
                //   isSeasonActive: true,
                //   isPostAllStarBreak: true
                // }
                
                const raceHorses = apiData.horses;
                const currentDate = new Date(apiData.currentDate);
                const gameDay = apiData.gameDay;
                const isSeasonActive = apiData.isSeasonActive;
                const isPostAllStarBreak = apiData.isPostAllStarBreak;
                
                runRaceAnimation({ raceHorses, currentDate, gameDay, isSeasonActive, isPostAllStarBreak, totalDuration, horseModal, raceStartDelay, audioContext });
            })
            .catch(error => {
                console.error('Error fetching race data:', error);
                // Fallback: derive horses from the live playersArray so it's always current
                const raceHorses = playersArray.map(p => ({
                    number:          p.number,
                    id:              p.id,
                    name:            p.name,
                    atBats:          p.liveAtBats || 0,
                    avg:             p.currentAvg || 0,
                    distanceFrom200: p.distanceFrom200 || 1000,
                }));
                const currentDate        = new Date();
                const gameDay            = 0;
                const isSeasonActive     = false;
                const isPostAllStarBreak = false;

                runRaceAnimation({ raceHorses, currentDate, gameDay, isSeasonActive, isPostAllStarBreak, totalDuration, horseModal, raceStartDelay, audioContext });
            });
    });
}

function runRaceAnimation({ raceHorses, currentDate, gameDay, isSeasonActive, isPostAllStarBreak, totalDuration, horseModal, raceStartDelay, audioContext }) {
        // Season dates come from the global SEASON config

        // Sort horses by race position
        let sortedHorses;
        if (isPostAllStarBreak) {
            // Sort by distance from .200 (closest first)
            sortedHorses = [...raceHorses].sort((a, b) => a.distanceFrom200 - b.distanceFrom200);
        } else if (isSeasonActive) {
            // Sort by at-bats (highest first)
            sortedHorses = [...raceHorses].sort((a, b) => b.atBats - a.atBats);
        } else {
            // Pre-season: randomize order every time
            sortedHorses = [...raceHorses].sort(() => Math.random() - 0.5);
        }
        
        // Calculate race positions based on actual progress
        // In first half: position = at-bats (200 AB = finish line)
        // In second half: position = closeness to .200 (finish line = .200 exactly)
        if (!isPostAllStarBreak && isSeasonActive) {
            // FIRST HALF: Track actual at-bats toward 200
            sortedHorses.forEach(horse => {
                horse.racePosition = horse.atBats; // Actual at-bats = position
            });
        } else if (isPostAllStarBreak) {
            // SECOND HALF: Track closeness to .200
            // distanceFrom200 is stored as decimal (e.g., 0.014 for .186, 0.001 for .201)
            // Convert to batting average points: multiply by 1000
            // e.g., .186 = 14 points away, .199 = 1 point away, .201 = 1 point away
            sortedHorses.forEach(horse => {
                const pointsFromMendoza = horse.distanceFrom200 * 1000;
                // Position scale: closest to .200 gets highest position
                // Max realistic distance is about 50 points (.150 or .250)
                // Scale so that .200 = finish line (200), others proportionally back
                horse.racePosition = Math.max(0, 200 - pointsFromMendoza);
            });
        } else {
            // PRE-SEASON: Random positions
            sortedHorses.forEach((horse, idx) => {
                horse.racePosition = sortedHorses.length - 1 - idx;
            });
        }
        
        const horseElement = document.getElementById('horse-animation');
        const horseText = document.getElementById('horse-text');
        
        // Reset horse text
        if (horseText) {
            horseText.style.visibility = 'hidden';
            horseText.textContent = '';
        }
        
        // Build text progressively during the bugle call - EVEN SPLIT
        // Set up the horseElement to display text in blue
        horseElement.style.fontSize = '0.9rem';
        horseElement.style.color = '#b8ddf2';
        horseElement.style.textAlign = 'center';
        horseElement.style.justifyContent = 'center';
        horseElement.style.alignItems = 'center';
        
        // Message 1: MendozaLeague.com Proudly Presents (0s - 2.17s)
        horseElement.innerHTML = 'MendozaLeague.com<br>Proudly Presents';
        
        // Message 2: The 3rd Running of the Mendoza Stakes (2.17s - 4.33s)
        setTimeout(() => {
            horseElement.innerHTML = 'The 3rd Running of<br>The Mendoza Stakes';
        }, 2170);
        
        // Message 3: Bob Uecker Memorial Race for Two Hundred (4.33s - 6.5s)
        setTimeout(() => {
            horseElement.innerHTML = 'Bob Uecker Memorial<br>Race for Two Hundred';
        }, 4330);
        
        // Final message: "...& they're OFF!!!" (at 6.5s - perfect timing)
        setTimeout(() => {
            horseElement.textContent = '...& they\'re OFF!!!';
        }, 6500);
        
        // After bugle call completes, play starting gun & start race
        setTimeout(() => {
            // Starting gun sound
            
            // Layer 1: White noise blast
            const gunNoise = audioContext.createBufferSource();
            const gunGain = audioContext.createGain();
            const gunFilter = audioContext.createBiquadFilter();
            
            const bufferSize = audioContext.sampleRate * 0.25;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            gunNoise.buffer = buffer;
            
            gunFilter.type = 'highpass';
            gunFilter.frequency.setValueAtTime(1500, audioContext.currentTime); // Even sharper
            gunFilter.Q.setValueAtTime(5, audioContext.currentTime); // More resonance
            
            gunGain.gain.setValueAtTime(3.0, audioContext.currentTime); // TRIPLED volume!
            gunGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            
            gunNoise.connect(gunFilter);
            gunFilter.connect(gunGain);
            gunGain.connect(audioContext.destination);
            gunNoise.start(audioContext.currentTime);
            gunNoise.stop(audioContext.currentTime + 0.25);
            
            // Layer 2: Low thump for impact
            const thumpOsc = audioContext.createOscillator();
            const thumpGain = audioContext.createGain();
            
            thumpOsc.type = 'sine';
            thumpOsc.frequency.setValueAtTime(60, audioContext.currentTime);
            
            thumpGain.gain.setValueAtTime(1.5, audioContext.currentTime);
            thumpGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            thumpOsc.connect(thumpGain);
            thumpGain.connect(audioContext.destination);
            thumpOsc.start(audioContext.currentTime);
            thumpOsc.stop(audioContext.currentTime + 0.1);
            
            horseElement.innerHTML = '';
            
            // Calculate dynamic race duration based on season state
            let actualRaceDuration;
            if (!isPostAllStarBreak && isSeasonActive) {
                // First half: based on leader's at-bats
                const leaderAtBats = Math.max(...raceHorses.map(h => h.atBats));
                actualRaceDuration = Math.min(6, Math.max(2, leaderAtBats / 40));
            } else if (isPostAllStarBreak) {
                // Second half: based on who's closest to .200
                const closestToMendoza = Math.max(...raceHorses.map(h => h.racePosition));
                actualRaceDuration = Math.min(6, Math.max(2, closestToMendoza / 40));
            } else {
                // Pre-season: standard duration
                actualRaceDuration = 6;
            }
            
            // GALLOPING SOUND - CRANKED UP with MULTIPLE HORSES!
            // Continue galloping until modal closes
            const totalGallopDuration = actualRaceDuration + 0.5 + 2; // race + buffer + countdown
            const gallopInterval = 0.15; // Time between gallops (faster = more hoofbeats)
            const numGallops = Math.floor(totalGallopDuration / gallopInterval);
            
            // Create three offset gallop patterns for multiple horse sound
            const gallopOffsets = [0, 0.05, 0.08]; // Slight offsets to create depth
            
            gallopOffsets.forEach((offset, horseIndex) => {
                // Create individual gallop sounds for each "horse"
                for (let i = 0; i < numGallops; i++) {
                    const startTime = audioContext.currentTime + (i * gallopInterval) + offset;
                    
                    // Create two quick thuds for each gallop (clip-clop)
                    for (let thud = 0; thud < 2; thud++) {
                        const thudTime = startTime + (thud * 0.05);
                        const thudOsc = audioContext.createOscillator();
                        const thudGain = audioContext.createGain();
                        const thudFilter = audioContext.createBiquadFilter();
                        
                        thudOsc.type = 'sine';
                        // Vary frequency slightly per horse for realism
                        thudOsc.frequency.setValueAtTime(80 + (thud * 20) + (horseIndex * 5), thudTime);
                        
                        thudFilter.type = 'lowpass';
                        thudFilter.frequency.setValueAtTime(300, thudTime);
                        
                        // Slightly lower volume per horse so combined isn't overwhelming
                        thudGain.gain.setValueAtTime(0.9, thudTime);
                        thudGain.gain.exponentialRampToValueAtTime(0.01, thudTime + 0.04);
                        
                        thudOsc.connect(thudFilter);
                        thudFilter.connect(thudGain);
                        thudGain.connect(audioContext.destination);
                        
                        thudOsc.start(thudTime);
                        thudOsc.stop(thudTime + 0.04);
                    }
                }
            });
            
            // Clear & setup race
            horseElement.innerHTML = '';
            
            // Reset horseElement styles for race display
            horseElement.style.fontSize = '1.5rem';
            horseElement.style.textAlign = 'left';
            horseElement.style.justifyContent = 'center';
            horseElement.style.alignItems = 'flex-start';
            
            // Show race title
            const raceTitle = document.getElementById('race-title');
            raceTitle.style.visibility = 'visible';
            
            // Show finish line - will be positioned to align with fences
            const finishLine = document.getElementById('finish-line');
            
            // Add fence at the top
            const fenceDiv = document.createElement('div');
            fenceDiv.style.cssText = `
                font-size: 0.7rem;
                line-height: 1;
                color: #b8ddf2;
                margin-bottom: 5px;
                overflow: hidden;
                white-space: nowrap;
            `;
            fenceDiv.textContent = '|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==';
            horseElement.appendChild(fenceDiv);
            
            // Create horse elements
            const allIntervals = [];
            raceHorses.forEach((horse, index) => {
                const horseDiv = document.createElement('div');
                horseDiv.style.cssText = `
                    display: flex;
                    align-items: center;
                    font-size: 0.65rem;
                    line-height: 1.2;
                    transform: translateX(0px);
                    position: relative;
                `;
                
                // Horse icon comes FIRST (on the left edge), names trail BEHIND (to the left, off-screen initially)
                const horseIcon = `
                    <span class="horse-icon-${index}" style="display: inline-block; transform: scaleX(-1); font-size: 1.3rem; position: relative;">ìÉó</span>
                `;
                
                const isSelectedInRace = getSelectedBatters().includes(horse.id);
                const nameStyle = isSelectedInRace
                    ? 'color: #b8ddf2; white-space: nowrap; text-shadow: 0.4px 0 0 #b8ddf2, -0.4px 0 0 #b8ddf2;'
                    : 'color: #b8ddf2; white-space: nowrap;';

                const playerInfo = `
                    <span style="display: flex; align-items: center; gap: 5px; position: absolute; right: calc(100% + 8px); white-space: nowrap;">
                        <span style="display: inline-block; width: 0.5rem; height: 0.5rem; background-color: #b8ddf2; transform: rotate(45deg); position: relative;">
                            <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 0.35rem; font-weight: bold; color: black;">${horse.number}</span>
                        </span>
                        <span style="${nameStyle}">${horse.name}</span>
                    </span>
                `;
                
                horseDiv.innerHTML = horseIcon + playerInfo;
                horseElement.appendChild(horseDiv);
                
                // Calculate animation based on mode
                let finalPosition, raceAnimationTime;
                
                if (!isPostAllStarBreak && isSeasonActive) {
                    // FIRST HALF: Position based on actual at-bats (200 AB = finish line)
                    // Scale dynamically to screen width, leaving room for finish line display
                    const modalWidth = horseElement.offsetWidth || 1000;
                    // Finish line is at ~15% from right edge (before "TWO HUNDRED" text)
                    const maxDistance = modalWidth * 0.70; // Use 70% of available width for race track
                    finalPosition = (horse.atBats / 200) * maxDistance;
                    
                    // Race duration based on leader's at-bats (more AB = longer animation)
                    const leaderAtBats = Math.max(...raceHorses.map(h => h.atBats));
                    raceAnimationTime = Math.min(6, Math.max(2, leaderAtBats / 40)); // 2-6 seconds
                    
                    // Speed variation: Leaders run faster (shorter duration)
                    // Top 3 horses get speed boost
                    const sortedByAB = [...raceHorses].sort((a, b) => b.atBats - a.atBats);
                    const horseRank = sortedByAB.findIndex(h => h.id === horse.id);
                    if (horseRank === 0) {
                        raceAnimationTime *= 0.85; // Leader 15% faster
                    } else if (horseRank === 1) {
                        raceAnimationTime *= 0.92; // 2nd place 8% faster
                    } else if (horseRank === 2) {
                        raceAnimationTime *= 0.96; // 3rd place 4% faster
                    }
                    
                    // Bell sound if horse has reached 200 AB
                    if (horse.atBats >= 200) {
                        const bellTime = audioContext.currentTime + (raceAnimationTime * 0.85);
                        
                        // Single bell chime
                        const bell = audioContext.createOscillator();
                        const bellGain = audioContext.createGain();
                        
                        bell.type = 'sine';
                        bell.frequency.setValueAtTime(1047, bellTime); // C6
                        bellGain.gain.setValueAtTime(0.7, bellTime);
                        bellGain.gain.exponentialRampToValueAtTime(0.01, bellTime + 1.0);
                        
                        bell.connect(bellGain);
                        bellGain.connect(audioContext.destination);
                        bell.start(bellTime);
                        bell.stop(bellTime + 1.0);
                    }
                } else if (isPostAllStarBreak) {
                    // SECOND HALF: map each horse's closeness to .200 onto the track width
                    // Closest horse ‚Üí rightmost (85% of track), furthest horse ‚Üí leftmost (15% of track)
                    const modalWidth = horseElement.offsetWidth || 800;
                    const trackWidth = modalWidth * 0.70;
                    const minPos = trackWidth * 0.15; // furthest-from-.200 horse stops here
                    const maxPos = trackWidth * 0.85; // closest-to-.200 horse stops here

                    const allDistances = raceHorses.map(h => h.distanceFrom200);
                    const minDist = Math.min(...allDistances); // closest to .200
                    const maxDist = Math.max(...allDistances); // furthest from .200

                    const distRange = maxDist - minDist;
                    if (distRange === 0) {
                        // All tied ‚Äî spread them out by index so they're never stacked
                        finalPosition = minPos + (raceHorses.indexOf(horse) / Math.max(raceHorses.length - 1, 1)) * (maxPos - minPos);
                    } else {
                        // Linear map: closer to .200 (smaller dist) ‚Üí larger finalPosition
                        finalPosition = minPos + ((maxDist - horse.distanceFrom200) / distRange) * (maxPos - minPos);
                    }

                    raceAnimationTime = 6; // Same duration for all so stagger is visible at end
                } else {
                    // PRE-SEASON: Use spread-based positioning
                    const modalWidth = horseElement.offsetWidth || 800;
                    const trackWidth = modalWidth * 0.70;
                    // Spread horses across track randomly
                    finalPosition = horse.racePosition * (trackWidth / raceHorses.length) + (Math.random() * 50);
                    raceAnimationTime = 6;
                }
                
                // Safety check
                if (isNaN(finalPosition) || finalPosition < 0) {
                    finalPosition = Math.random() * 200;
                }
                
                // Animate to final position with jerky 8-bit motion
                let currentPosition = 0;
                const steps = 12;
                const stepSize = finalPosition / steps;
                const stepDuration = (raceAnimationTime * 1000) / steps;
                
                let stepCount = 0;
                let gallopFrame = Math.random() < 0.5 ? 0 : 1; // Random start
                
                // Get the horse icon element for bouncing
                const horseIconElement = horseDiv.querySelector(`.horse-icon-${index}`);
                
                // Independent gallop animation - only affects horse icon
                const gallopInterval = setInterval(() => {
                    gallopFrame = 1 - gallopFrame; // Toggle between 0 & 1
                    const yOffset = gallopFrame === 0 ? -5 : 0;
                    if (horseIconElement) {
                        horseIconElement.style.transform = `scaleX(-1) translateY(${yOffset}px)`;
                    }
                }, 140);
                
                // Horizontal movement - affects entire row (name + horse)
                const moveInterval = setInterval(() => {
                    if (stepCount >= steps) {
                        clearInterval(moveInterval);
                        clearInterval(gallopInterval);
                        horseDiv.style.transform = `translateX(${Math.floor(currentPosition)}px)`;
                        if (horseIconElement) {
                            horseIconElement.style.transform = `scaleX(-1) translateY(0px)`;
                        }
                        return;
                    }
                    currentPosition += stepSize;
                    horseDiv.style.transform = `translateX(${Math.floor(currentPosition)}px)`;
                    stepCount++;
                }, stepDuration);
                
                // Store intervals for cleanup
                allIntervals.push(gallopInterval, moveInterval);
            });
            
            // Add fence at the bottom
            const bottomFenceDiv = document.createElement('div');
            bottomFenceDiv.style.cssText = `
                font-size: 0.7rem;
                line-height: 1;
                color: #b8ddf2;
                margin-top: 5px;
                margin-bottom: 10px;
                overflow: hidden;
                white-space: nowrap;
            `;
            bottomFenceDiv.textContent = '|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==|==';
            horseElement.appendChild(bottomFenceDiv);
            
            // Position & show finish line between the fences
            setTimeout(() => {
                const topFenceRect = fenceDiv.getBoundingClientRect();
                const bottomFenceRect = bottomFenceDiv.getBoundingClientRect();
                const containerRect = horseElement.getBoundingClientRect();
                
                const topPosition = topFenceRect.bottom - containerRect.top;
                const bottomPosition = bottomFenceRect.top - containerRect.top;
                const height = bottomPosition - topPosition;
                
                finishLine.style.top = topPosition + 'px';
                finishLine.style.height = height + 'px';
                finishLine.style.display = 'flex';
                finishLine.style.justifyContent = 'space-between';
                finishLine.textContent = `|     |
|     |
|     |
|     |
|     |
|  T  |
|  W  |
|  O  |
|     |
|     |
|  H  |
|  U  |
|  N  |
|  D  |
|  R  |
|  E  |
|  D  |
|     |
|     |
|     |
|     |`;
            }, 50);
            
            // Build leaderboard text if season is active
            if (isSeasonActive) {
                const top3 = sortedHorses.slice(0, 3).map((horse, idx) => {
                    let stats;
                    if (isPostAllStarBreak) {
                        // Show batting average in second half
                        stats = horse.avg.toFixed(3);
                    } else {
                        // Show at-bats in first half
                        stats = `${horse.atBats}AB`;
                    }
                    const position = idx === 0 ? '1st' : idx === 1 ? '2nd' : '3rd';
                    
                    // Add trophy for first to 200AB (only in first half)
                    const trophy = (!isPostAllStarBreak && horse.atBats >= 200 && idx === 0) 
                        ? '<span style="filter: grayscale(100%) brightness(1.5) sepia(100%) hue-rotate(170deg) saturate(300%); margin-left: 5px;">üèÜ</span>' 
                        : '';
                    
                    return `<div style="height: 1.3rem; display: flex; align-items: center; justify-content: center; font-weight: normal;">${position}: ${horse.name} ${stats}${trophy}</div>`;
                });
                
                const dayHeaderHtml = `<div style="height: 1.3rem; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 0.2rem;">DAY ${gameDay} STANDINGS</div>`;
                
                // Create placeholder divs for all 3 lines to lock positions
                const emptyLine = `<div style="height: 1.3rem;"></div>`;
                
                // Show DAY header earlier
                setTimeout(() => {
                    if (horseText) {
                        horseText.innerHTML = dayHeaderHtml + emptyLine + emptyLine + emptyLine;
                        horseText.style.visibility = 'visible';
                    }
                }, 500);
                
                // Hold a moment before first player
                setTimeout(() => {
                    if (horseText) {
                        horseText.innerHTML = dayHeaderHtml + emptyLine + emptyLine + emptyLine;
                    }
                }, 1200);
                
                // Show leaderboard progressively with slower cadence
                setTimeout(() => {
                    if (horseText) {
                        horseText.innerHTML = dayHeaderHtml + top3[0] + emptyLine + emptyLine;
                        horseText.style.visibility = 'visible';
                    }
                }, 1800);
                
                setTimeout(() => {
                    if (horseText && top3[1]) {
                        horseText.innerHTML = dayHeaderHtml + top3[0] + top3[1] + emptyLine;
                    }
                }, 3000);
                
                setTimeout(() => {
                    if (horseText && top3[2]) {
                        horseText.innerHTML = dayHeaderHtml + top3[0] + top3[1] + top3[2];
                    }
                }, 4200);
            } else {
                // Pre-season ONLY: show messages one at a time with black screens between
                const raceTime = 6000; // 6 seconds of race animation
                
                // Message 1: "This is just a simulation"
                setTimeout(() => {
                    if (horseText) {
                        horseText.textContent = "This is just a simulation";
                        horseText.style.visibility = 'visible';
                    }
                }, raceTime * 0.20); // 1200ms
                
                // Black screen after message 1
                setTimeout(() => {
                    if (horseText) {
                        horseText.textContent = "";
                    }
                }, raceTime * 0.50); // 3000ms
                
                // Message 2: "View race LIVE starting Opening Day"
                setTimeout(() => {
                    if (horseText) {
                        horseText.textContent = "View race LIVE starting Opening Day";
                    }
                }, raceTime * 0.70); // 4200ms
            }
            
            // When animation ends, show countdown
            setTimeout(() => {
                // Clear all horse animations
                allIntervals.forEach(interval => clearInterval(interval));
                
                if (horseText) {
                    horseText.style.visibility = 'hidden';
                }
                
                // Hide finish line
                const finishLine = document.getElementById('finish-line');
                finishLine.style.display = 'none';
                
                // Hide race title
                const raceTitle = document.getElementById('race-title');
                raceTitle.style.visibility = 'hidden';
                
                // Calculate countdown text based on season phase (for race animation end)
                let countdownText;
                
                // Season dates from global SEASON config
                const springTrainingStart = SEASON.springTraining;
                const openingDayDate      = SEASON.openingDay;
                const allStarBreakStart   = SEASON.allStarBreakStart;
                const allStarBreakEnd     = SEASON.allStarBreakEnd;
                const seasonEnd           = SEASON.finishLine;
                
                if (currentDate < springTrainingStart) {
                    // PRESEASON: Before spring training
                    const daysLeft = Math.max(0, Math.ceil((springTrainingStart - currentDate) / (1000 * 60 * 60 * 24)));
                    const dayWord = daysLeft === 1 ? 'Day' : 'Days';
                    countdownText = `${daysLeft} ${dayWord} 'til Spring!`;
                    
                } else if (currentDate >= springTrainingStart && currentDate < openingDayDate) {
                    // SPRING TRAINING: After spring training starts, before opening day
                    const daysLeft = Math.max(0, Math.ceil((openingDayDate - currentDate) / (1000 * 60 * 60 * 24)));
                    const dayWord = daysLeft === 1 ? 'Day' : 'Days';
                    countdownText = `${daysLeft} ${dayWord} to Post Time!`;
                    
                } else if (currentDate >= openingDayDate && currentDate < allStarBreakStart) {
                    // 1ST HALF: Opening day to all-star break
                    const daysLeft = Math.max(0, Math.ceil((allStarBreakStart - currentDate) / (1000 * 60 * 60 * 24)));
                    const dayWord = daysLeft === 1 ? 'Day' : 'Days';
                    countdownText = `${daysLeft} ${dayWord} 'til The Break!`;
                    
                } else if (currentDate >= allStarBreakStart && currentDate < allStarBreakEnd) {
                    // ALL-STAR BREAK: During the break
                    const daysLeft = Math.max(0, Math.ceil((allStarBreakEnd - currentDate) / (1000 * 60 * 60 * 24)));
                    const dayWord = daysLeft === 1 ? 'Day' : 'Days';
                    countdownText = `${daysLeft} ${dayWord} 'til the 2nd Half!`;
                    
                } else {
                    // 2ND HALF: After all-star break to season end
                    const daysLeft = Math.max(0, Math.ceil((seasonEnd - currentDate) / (1000 * 60 * 60 * 24)));
                    const dayWord = daysLeft === 1 ? 'Day' : 'Days';
                    countdownText = `${daysLeft} ${dayWord} to The Finish Line!!`;
                }
                
                horseElement.innerHTML = `<div style="font-size: 0.7rem; text-align: center; width: 100%;">${countdownText}</div>`;
                
                // Close modal after 2 seconds
                setTimeout(() => {
                        closeModalWithScroll(horseModal);
                }, 2000);
                
            }, (actualRaceDuration * 1000) + 500); // Dynamic race duration + 500ms buffer
            
        }, raceStartDelay); // Use fixed 7200ms delay instead of audio-based timing
}
    </script>
</body>
</html>
